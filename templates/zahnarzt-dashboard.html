{% extends 'layout.html' %}

{% block styles %}
<style>
  .dashboard-topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1050;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    padding: 0.6rem 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .dashboard-topbar-logo img {
    transition: opacity 0.2s;
  }
  .dashboard-topbar-logo:hover img {
    opacity: 0.8;
  }
</style>
{% endblock %}

{% block navigation %}
<nav class="dashboard-topbar">
  <div class="d-flex align-items-center justify-content-between w-100">
    <a href="/" class="dashboard-topbar-logo">
      <img src="{{ url_for('static', filename='img/dentalax-logo.png') }}" alt="Dentalax Logo" style="height: 42px;">
    </a>
    <div class="d-flex align-items-center gap-2">
      <a href="/" class="btn btn-sm btn-outline-secondary d-none d-md-inline-flex align-items-center">
        <i class="fas fa-globe me-1"></i> Zur Website
      </a>
      {% if praxis and praxis.landingpage_aktiv %}
      <a href="{{ url_for('praxis_landingpage', slug=praxis.slug) }}" target="_blank" class="btn btn-sm btn-outline-primary d-none d-sm-inline-flex align-items-center">
        <i class="fas fa-external-link-alt me-1"></i> Landingpage
      </a>
      {% endif %}
      <div class="dropdown">
        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-user-circle me-1"></i> <span class="d-none d-sm-inline">Mein Konto</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><span class="dropdown-item-text small text-muted">{{ current_user.email }}</span></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="/"><i class="fas fa-globe me-2 text-primary"></i> Zur Website</a></li>
          {% if praxis and praxis.landingpage_aktiv %}
          <li><a class="dropdown-item" href="{{ url_for('praxis_landingpage', slug=praxis.slug) }}" target="_blank"><i class="fas fa-external-link-alt me-2 text-primary"></i> Landingpage</a></li>
          {% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i> Ausloggen</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>
{% endblock %}

{% block footer %}{% endblock %}

{% block content %}

<section class="py-4" style="padding-top: 80px !important;">
  <div class="container-fluid px-4">
    <div class="row align-items-center mb-4">
      <div class="col-md-6">
        <h1 class="h3 fw-bold text-primary mb-1">Praxis-Dashboard</h1>
        <p class="text-muted mb-0">Willkommen zurück{% if praxis %}, {{ praxis.name }}{% endif %}</p>
      </div>
      <div class="col-md-6 text-md-end">
        {% if praxis and praxis.paket %}
        <span class="badge bg-success me-2">{{ praxis.paket }}</span>
        {% endif %}
      </div>
    </div>

    <div class="row">
      <!-- Linke Spalte: Navigation -->
      <div class="col-lg-3 mb-4">
        <div class="card border-0 shadow-sm sticky-lg-top" style="top: 80px; z-index: 1000;">
          <div class="list-group list-group-flush">
            <a href="/zahnarzt-dashboard" class="list-group-item list-group-item-action fw-medium{% if not request.args.get('page') %} active{% endif %}">
              <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
            <a href="/zahnarzt-dashboard?page=landingpage" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'landingpage' %} active{% endif %}">
              <i class="fas fa-globe me-2"></i> Landingpage
            </a>
            <a href="/zahnarzt-dashboard?page=praxisdaten" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'praxisdaten' %} active{% endif %}">
              <i class="fas fa-clinic-medical me-2"></i> Praxisdaten
            </a>
            <a href="{{ url_for('dashboard_termine') }}" class="list-group-item list-group-item-action fw-medium">
              <i class="fas fa-calendar-alt me-2"></i> Terminverwaltung
            </a>
            <a href="{{ url_for('dashboard_verfuegbarkeiten') }}" class="list-group-item list-group-item-action fw-medium">
              <i class="fas fa-clock me-2"></i> Verfügbarkeiten
            </a>
            <a href="{{ url_for('dashboard_bestandspatienten') }}" class="list-group-item list-group-item-action fw-medium">
              <i class="fas fa-users me-2"></i> Stammpatientenkartei
            </a>
            <a href="/zahnarzt-dashboard?page=termine" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'termine' %} active{% endif %}">
              <i class="fas fa-cog me-2"></i> Buchungsmodus
            </a>
            <a href="/zahnarzt-dashboard?page=bewertungen" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'bewertungen' %} active{% endif %}">
              <i class="fas fa-star me-2"></i> Bewertungen
            </a>
            <a href="/zahnarzt-dashboard?page=abrechnung" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'abrechnung' %} active{% endif %}">
              <i class="fas fa-credit-card me-2"></i> Plan & Abrechnung
            </a>
            {% if praxis and praxis.paket|lower == 'premiumplus' %}
            <a href="/zahnarzt-dashboard?page=stellenangebote" class="list-group-item list-group-item-action fw-medium{% if request.args.get('page') == 'stellenangebote' %} active{% endif %}">
              <i class="fas fa-briefcase me-2"></i> Stellenangebote
            </a>
            {% endif %}
          </div>
        </div>
        
        <!-- Profil-Box -->
        <div class="card border-0 shadow-sm mt-3">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              {% if portrait_bild %}
              <img src="{{ portrait_bild.pfad }}" alt="Portrait" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
              {% else %}
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="fas fa-user"></i>
              </div>
              {% endif %}
              <div>
                <h6 class="mb-0">{% if praxis %}{{ praxis.name }}{% else %}Meine Praxis{% endif %}</h6>
                <small class="text-muted">{% if current_user.email %}{{ current_user.email }}{% endif %}</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Support-Box -->
        <div class="card border-0 shadow-sm mt-3">
          <div class="card-body">
            <h5 class="card-title fw-bold mb-3"><i class="fas fa-headset me-2 text-primary"></i>Support</h5>
            <p class="small text-muted mb-3">Haben Sie Fragen oder benötigen Hilfe?</p>
            <div class="d-grid gap-2">
              <a href="#" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-book me-1"></i> Hilfebereich
              </a>
              <a href="#" class="btn btn-sm btn-primary">
                <i class="fas fa-envelope me-1"></i> Kontakt aufnehmen
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Rechte Spalte: Dashboard-Inhalte -->
      <div class="col-lg-9">
        <!-- Main Dashboard Content -->
        <div id="dashboard-main" {% if request.args.get('page') %}style="display: none;"{% endif %}>
          <!-- Quick Stats Row -->
          <div class="row g-3 mb-4">
            <!-- Terminanfragen -->
            <div class="col-md-6 col-xl-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="stat-icon-circle bg-light-primary">
                        <i class="fas fa-envelope text-primary"></i>
                      </div>
                    </div>
                    <div>
                      <h6 class="card-title text-muted mb-0">Terminanfragen</h6>
                      <h4 class="fw-bold mb-0">{{ ausstehende_count|default(terminanfragen|length) }}</h4>
                    </div>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ [ausstehende_count|default(terminanfragen|length) * 10, 100]|min }}%;" aria-valuenow="{{ ausstehende_count|default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">
                      <i class="fas fa-clock me-1"></i> {{ ausstehende_count|default(0) }} ausstehend
                    </small>
                    <small class="text-primary">
                      {{ termine_gesamt|default(0) }} gesamt
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Termine heute -->
            <div class="col-md-6 col-xl-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="stat-icon-circle bg-light-info">
                        <i class="fas fa-calendar-check text-info"></i>
                      </div>
                    </div>
                    <div>
                      <h6 class="card-title text-muted mb-0">Termine heute</h6>
                      <h4 class="fw-bold mb-0">{{ termine_heute_count|default(0) }}</h4>
                    </div>
                  </div>
                  <div class="progress" style="height: 6px;">
                    {% set progress = (termine_bestaetigt|default(0) / termine_heute_count * 100) if termine_heute_count|default(0) > 0 else 0 %}
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ progress|int }}%;" aria-valuenow="{{ progress|int }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">
                      <i class="fas fa-check-circle me-1"></i> {{ termine_bestaetigt|default(0) }} davon bestätigt
                    </small>
                    <small class="text-info">
                      {{ termine_heute_count|default(0) - termine_bestaetigt|default(0) }} offen
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Leistungen -->
            <div class="col-md-6 col-xl-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="stat-icon-circle bg-light-success">
                        <i class="fas fa-tooth text-success"></i>
                      </div>
                    </div>
                    <div>
                      <h6 class="card-title text-muted mb-0">Leistungen</h6>
                      <h4 class="fw-bold mb-0">{{ leistungen|length }}</h4>
                    </div>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ [leistungen|length * 10, 100]|min }}%;" aria-valuenow="{{ leistungen|length }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">
                      <i class="fas fa-list me-1"></i> Angebotene Services
                    </small>
                    <small class="text-success">
                      {% if leistungen|length >= 5 %}Gut{% else %}Mehr hinzufügen{% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Bewertungen -->
            <div class="col-md-6 col-xl-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="stat-icon-circle bg-light-warning">
                        <i class="fas fa-star text-warning"></i>
                      </div>
                    </div>
                    <div>
                      <h6 class="card-title text-muted mb-0">Bewertungen</h6>
                      <h4 class="fw-bold mb-0">{{ bewertungen_durchschnitt|default(0) }} <small class="text-muted fs-6">/ 5</small></h4>
                    </div>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (bewertungen_durchschnitt|default(0) / 5 * 100)|int }}%;" aria-valuenow="{{ (bewertungen_durchschnitt|default(0) / 5 * 100)|int }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">
                      <i class="fas fa-comment me-1"></i> {{ bewertungen_count|default(0) }} Bewertungen
                    </small>
                    <small class="text-warning">
                      {% for i in range(bewertungen_durchschnitt|default(0)|int) %}
                        <i class="fas fa-star me-1"></i>
                      {% endfor %}
                      {% if bewertungen_durchschnitt|default(0) - (bewertungen_durchschnitt|default(0)|int) >= 0.5 %}
                        <i class="fas fa-star-half-alt"></i>
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Linke Spalte (7/12) -->
            <div class="col-xl-7 mb-4">
              <!-- Kommende Termine (nächste 7 Tage) -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                  <h5 class="card-title m-0 fw-bold">
                    <i class="fas fa-calendar-alt me-2 text-primary"></i>Kommende Termine
                  </h5>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary">{{ kommende_termine_woche|length }} in 7 Tagen</span>
                    <a href="{{ url_for('dashboard_termine') }}" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-calendar me-1"></i>Alle Termine
                    </a>
                  </div>
                </div>
                <div class="card-body p-0">
                  {% if kommende_termine_woche and kommende_termine_woche|length > 0 %}
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th class="ps-3">Datum</th>
                          <th>Uhrzeit</th>
                          <th>Patient</th>
                          <th>Behandlung</th>
                          <th>Status</th>
                          <th class="pe-3">Aktion</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for termin in kommende_termine_woche[:10] %}
                        <tr>
                          <td class="ps-3">
                            <span class="fw-medium">{{ termin.datum.strftime('%d.%m.') if termin.datum else '-' }}</span>
                            <br><small class="text-muted">{{ ['Mo','Di','Mi','Do','Fr','Sa','So'][termin.datum.weekday()] if termin.datum else '' }}</small>
                          </td>
                          <td>
                            <span class="fw-medium text-primary">{{ termin.uhrzeit.strftime('%H:%M') if termin.uhrzeit else '--:--' }}</span>
                          </td>
                          <td>
                            <span class="fw-medium">{{ termin.patient_name or 'Unbekannt' }}</span>
                            {% if termin.gast_email %}
                            <br><small class="text-muted">{{ termin.gast_email }}</small>
                            {% endif %}
                          </td>
                          <td>
                            {% if termin.behandlungsart %}
                              {{ termin.behandlungsart.name }}
                            {% elif termin.grund %}
                              {{ termin.grund[:30] }}
                            {% else %}
                              -
                            {% endif %}
                          </td>
                          <td>
                            {% if termin.status == 'bestaetigt' %}
                              <span class="badge bg-success">Bestätigt</span>
                            {% elif termin.status == 'ausstehend' %}
                              <span class="badge bg-warning text-dark">Ausstehend</span>
                            {% endif %}
                          </td>
                          <td class="pe-3">
                            {% if termin.status == 'ausstehend' %}
                            <form action="{{ url_for('dashboard_termin_bestaetigen', termin_id=termin.id) }}" method="POST" class="d-inline">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <input type="hidden" name="redirect_to" value="dashboard">
                              <button type="submit" class="btn btn-outline-success btn-sm" title="Bestätigen">
                                <i class="fas fa-check"></i>
                              </button>
                            </form>
                            {% endif %}
                            <form action="{{ url_for('dashboard_termin_absagen', termin_id=termin.id) }}" method="POST" class="d-inline">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <input type="hidden" name="redirect_to" value="dashboard">
                              <button type="submit" class="btn btn-outline-danger btn-sm" title="Absagen">
                                <i class="fas fa-times"></i>
                              </button>
                            </form>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% if kommende_termine_woche|length > 10 %}
                  <div class="p-3 text-center border-top">
                    <a href="{{ url_for('dashboard_termine') }}" class="text-decoration-none">
                      <i class="fas fa-arrow-right me-1"></i>Alle {{ kommende_termine_woche|length }} Termine anzeigen
                    </a>
                  </div>
                  {% endif %}
                  {% else %}
                  <div class="p-5 text-center">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-1">Keine Termine in den nächsten 7 Tagen</p>
                    <small class="text-muted">Neue Termine erscheinen hier automatisch</small>
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- Aktuelle Bewerbungen -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                  <h5 class="card-title m-0 fw-bold">
                    <i class="fas fa-user-tie me-2 text-primary"></i>Aktuelle Bewerbungen
                  </h5>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary">{{ bewerbungen|length }}</span>
                  </div>
                </div>
                <div class="card-body p-0">
                  {% if bewerbungen and bewerbungen|length > 0 %}
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th class="ps-3">Bewerber</th>
                          <th>Stelle</th>
                          <th>Eingegangen</th>
                          <th>Status</th>
                          <th class="pe-3">Aktion</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for b in bewerbungen[:10] %}
                        <tr>
                          <td class="ps-3">
                            <span class="fw-medium">{{ b.vorname }} {{ b.nachname }}</span>
                            {% if b.telefon %}
                            <br><small class="text-muted"><i class="fas fa-phone me-1"></i>{{ b.telefon }}</small>
                            {% endif %}
                          </td>
                          <td>
                            <span class="text-truncate d-inline-block" style="max-width: 160px;">{{ b.stellenangebot.titel if b.stellenangebot else '-' }}</span>
                          </td>
                          <td>
                            <span class="fw-medium">{{ b.eingegangen_am.strftime('%d.%m.%Y') if b.eingegangen_am else '-' }}</span>
                            <br><small class="text-muted">{{ b.eingegangen_am.strftime('%H:%M') if b.eingegangen_am else '' }}</small>
                          </td>
                          <td>
                            {% if b.status == 'neu' %}
                              <span class="badge bg-info text-white">Neu</span>
                            {% elif b.status == 'in_bearbeitung' %}
                              <span class="badge bg-warning text-dark">In Bearbeitung</span>
                            {% elif b.status == 'eingeladen' %}
                              <span class="badge bg-primary">Eingeladen</span>
                            {% elif b.status == 'angenommen' %}
                              <span class="badge bg-success">Angenommen</span>
                            {% elif b.status == 'abgelehnt' %}
                              <span class="badge bg-danger">Abgelehnt</span>
                            {% else %}
                              <span class="badge bg-secondary">{{ b.status|capitalize }}</span>
                            {% endif %}
                          </td>
                          <td class="pe-3">
                            <a href="{{ url_for('dashboard_bewerbung_detail', bewerbung_id=b.id) }}" class="btn btn-outline-primary btn-sm" title="Ansehen">
                              <i class="fas fa-eye"></i>
                            </a>
                            {% if b.telefon %}
                            <a href="tel:{{ b.telefon }}" class="btn btn-outline-success btn-sm" title="Anrufen">
                              <i class="fas fa-phone"></i>
                            </a>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% if bewerbungen|length > 10 %}
                  <div class="p-3 text-center border-top">
                    <a href="#bewerbungen-section" class="text-decoration-none">
                      <i class="fas fa-arrow-right me-1"></i>Alle {{ bewerbungen|length }} Bewerbungen anzeigen
                    </a>
                  </div>
                  {% endif %}
                  {% else %}
                  <div class="p-5 text-center">
                    <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-1">Noch keine Bewerbungen eingegangen</p>
                    <small class="text-muted">Neue Bewerbungen erscheinen hier automatisch</small>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Rechte Spalte (5/12) -->
            <div class="col-xl-5">
              <!-- Terminanfragen -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                  <h5 class="card-title m-0 fw-bold">
                    <i class="fas fa-envelope me-2 text-primary"></i>Offene Anfragen
                  </h5>
                  <span class="badge bg-primary">{{ terminanfragen|length }}</span>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    {% if terminanfragen and terminanfragen|length > 0 %}
                      {% for anfrage in terminanfragen[:5] %}
                      <div class="list-group-item p-3">
                        <div class="d-flex justify-content-between mb-1">
                          {% if anfrage.status == 'ausstehend' %}
                            <span class="badge bg-warning text-dark">Ausstehend</span>
                          {% elif anfrage.status == 'neu' %}
                            <span class="badge bg-danger">Neu</span>
                          {% elif anfrage.status == 'bestaetigt' %}
                            <span class="badge bg-success">Bestätigt</span>
                          {% else %}
                            <span class="badge bg-secondary">{{ anfrage.status|capitalize }}</span>
                          {% endif %}
                          {% if anfrage.datum is defined and anfrage.datum %}
                            <small class="text-muted"><i class="fas fa-calendar me-1"></i>{{ anfrage.datum.strftime('%d.%m.%Y') }} {% if anfrage.uhrzeit is defined and anfrage.uhrzeit %}{{ anfrage.uhrzeit.strftime('%H:%M') }}{% endif %}</small>
                          {% elif anfrage.erstellt_am is defined and anfrage.erstellt_am %}
                            <small class="text-muted">{{ anfrage.erstellt_am.strftime('%d.%m.%Y') }}</small>
                          {% endif %}
                        </div>
                        <p class="mb-0 fw-medium">{{ anfrage.patient_name if anfrage.patient_name is defined else anfrage.name }}</p>
                        <small class="text-muted">
                          {% if anfrage.gast_email is defined and anfrage.gast_email %}
                            <i class="fas fa-envelope me-1"></i>{{ anfrage.gast_email }}
                          {% endif %}
                          {% if anfrage.grund %} · {{ anfrage.grund }}{% endif %}
                        </small>
                      </div>
                      {% endfor %}
                      {% if terminanfragen|length > 5 %}
                      <a href="{{ url_for('dashboard_termine') }}" class="list-group-item list-group-item-action p-3 text-center">
                        <i class="fas fa-arrow-right me-1"></i> Alle {{ terminanfragen|length }} anzeigen
                      </a>
                      {% endif %}
                    {% else %}
                      <div class="list-group-item p-4 text-center">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Keine offenen Anfragen</p>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Landingpage Content -->
        <div id="landingpage-content" class="dashboard-content" {% if request.args.get('page') != 'landingpage' %}style="display: none;"{% endif %}>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-globe me-2 text-primary"></i>Landingpage-Verwaltung
              </h5>
              <div>
                {% if praxis and praxis.slug %}
                <a href="{{ url_for('praxis_landingpage_vorschau', slug=praxis.slug) }}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                  <i class="fas fa-eye me-1"></i> Vorschau
                </a>
                {% endif %}
                <form action="/dashboard/veroeffentlichen" method="post" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-success">
                    <i class="fas fa-cloud-upload-alt me-1"></i> {% if praxis and praxis.landingpage_aktiv %}Aktualisieren{% else %}Veröffentlichen{% endif %}
                  </button>
                </form>
              </div>
            </div>
            <div class="card-body">
              {% if praxis and praxis.landingpage_aktiv %}
              <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle me-2"></i> Ihre Landingpage ist live unter: <a href="{{ url_for('praxis_landingpage', slug=praxis.slug) }}" target="_blank"><strong>/praxis/{{ praxis.slug }}</strong></a>
              </div>
              {% else %}
              <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i> Füllen Sie die Bereiche unten aus und klicken Sie auf "Veröffentlichen", um Ihre Landingpage live zu schalten.
              </div>
              {% endif %}
              
              <!-- Accordion für die Sektionen -->
              <div class="accordion mb-4" id="landingpageAccordion">
                <!-- Header-Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingHeader">
                    <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHeader" aria-expanded="true" aria-controls="collapseHeader">
                      <i class="fas fa-image me-2 text-primary"></i> Header-Bereich (Hero)
                    </button>
                  </h2>
                  <div id="collapseHeader" class="accordion-collapse collapse show" aria-labelledby="headingHeader" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <form action="{{ url_for('dashboard_hero_speichern') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label for="hero_titel" class="form-label">Hauptüberschrift</label>
                            <input type="text" class="form-control" id="hero_titel" name="hero_titel" value="{{ praxis.hero_titel if praxis and praxis.hero_titel else praxis.name if praxis else '' }}">
                          </div>
                          <div class="col-md-6 mb-3">
                            <label for="hero_untertitel" class="form-label">Unterüberschrift</label>
                            <div class="input-group">
                              <input type="text" class="form-control" id="hero_untertitel" name="hero_untertitel" value="{{ praxis.hero_untertitel if praxis and praxis.hero_untertitel else 'Ihre moderne Zahnarztpraxis' }}">
                              <button type="button" class="btn btn-outline-primary" onclick="generateAIText('hero', 'hero_untertitel')" title="Mit KI generieren">
                                <i class="fas fa-magic"></i>
                              </button>
                            </div>
                          </div>
                          <div class="col-12 mb-3">
                            <label class="form-label">Hero-Bild</label>
                            <div class="d-flex align-items-start border rounded p-3">
                              <div class="me-3 text-center">
                                {% if hero_bild %}
                                <img src="{{ hero_bild.pfad }}" alt="Hero Bild" class="img-fluid rounded shadow-sm" style="max-height: 100px; max-width: 200px; object-fit: cover;">
                                <div class="mt-1">
                                  <small class="text-success"><i class="fas fa-check-circle me-1"></i>Gespeichert</small>
                                </div>
                                {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center rounded" style="width: 200px; height: 100px;">
                                  <i class="fas fa-image text-muted fa-2x"></i>
                                </div>
                                <div class="mt-1">
                                  <small class="text-muted">Kein Bild</small>
                                </div>
                                {% endif %}
                              </div>
                              <div class="flex-grow-1">
                                <label class="form-label small text-muted mb-1">{% if hero_bild %}Neues Bild hochladen{% else %}Bild auswählen{% endif %}</label>
                                <input type="file" class="form-control" id="titelbild" name="titelbild" accept="image/*">
                                <small class="text-muted">Empfohlen: 1920x600 Pixel</small>
                              </div>
                            </div>
                          </div>
                          <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                              <i class="fas fa-save me-1"></i> Hero-Bereich speichern
                            </button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <!-- Über uns & Portrait Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingAbout">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAbout" aria-expanded="false" aria-controls="collapseAbout">
                      <i class="fas fa-info-circle me-2 text-primary"></i> Über uns & Portrait
                    </button>
                  </h2>
                  <div id="collapseAbout" class="accordion-collapse collapse" aria-labelledby="headingAbout" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <form action="{{ url_for('dashboard_praxisdaten_speichern') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                          <div class="col-12 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <label for="ueber_uns" class="form-label mb-0">Über Ihre Praxis</label>
                              <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateAIText('ueber_uns', 'ueber_uns')">
                                <i class="fas fa-magic me-1"></i> Mit KI generieren
                              </button>
                            </div>
                            <textarea class="form-control" id="ueber_uns" name="ueber_uns" rows="5">{{ praxis.ueber_uns_text if praxis and praxis.ueber_uns_text else '' }}</textarea>
                            <small class="text-muted">Beschreiben Sie Ihre Praxis, Philosophie und was Sie auszeichnet.</small>
                          </div>
                          <div class="col-12 mb-3">
                            <label for="beschreibung" class="form-label">Kurzbeschreibung</label>
                            <textarea class="form-control" id="beschreibung" name="beschreibung" rows="2">{{ praxis.beschreibung if praxis and praxis.beschreibung else '' }}</textarea>
                            <small class="text-muted">Kurze Beschreibung für die Suche und Übersichten.</small>
                          </div>
                          <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                              <i class="fas fa-save me-1"></i> Speichern
                            </button>
                          </div>
                        </div>
                      </form>
                      
                      <hr class="my-4">
                      
                      <div class="row">
                        <div class="col-md-4 mb-3">
                          <h6 class="fw-bold mb-3"><i class="fas fa-user-md me-2 text-primary"></i> Portrait-Bild</h6>
                          <form action="{{ url_for('dashboard_portrait_speichern') }}" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="d-flex align-items-center border rounded p-3">
                              {% if portrait_bild %}
                              <img src="{{ portrait_bild.pfad }}" alt="Portrait" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                              {% else %}
                              <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-user text-muted fa-2x"></i>
                              </div>
                              {% endif %}
                              <div class="flex-grow-1">
                                <input type="file" class="form-control mb-2" name="portrait_bild" accept="image/*">
                                <button type="submit" class="btn btn-sm btn-primary">
                                  <i class="fas fa-upload me-1"></i> Hochladen
                                </button>
                              </div>
                            </div>
                          </form>
                        </div>
                        <div class="col-md-4 mb-3">
                          <h6 class="fw-bold mb-3"><i class="fas fa-image me-2 text-primary"></i> Praxis-Logo</h6>
                          <form action="{{ url_for('dashboard_logo_speichern') }}" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="d-flex align-items-center border rounded p-3">
                              {% if logo_bild %}
                              <img src="{{ logo_bild.pfad }}" alt="Logo" class="me-3" style="width: 80px; height: 80px; object-fit: contain;">
                              {% else %}
                              <div class="bg-light d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px; border-radius: 8px;">
                                <i class="fas fa-image text-muted fa-2x"></i>
                              </div>
                              {% endif %}
                              <div class="flex-grow-1">
                                <input type="file" class="form-control mb-2" name="logo_bild" accept="image/*">
                                <button type="submit" class="btn btn-sm btn-primary">
                                  <i class="fas fa-upload me-1"></i> Hochladen
                                </button>
                              </div>
                            </div>
                            <small class="text-muted d-block mt-2">Ihr Logo erscheint auf der Landingpage und in Suchergebnissen.</small>
                          </form>
                        </div>
                        <div class="col-md-4 mb-3">
                          <h6 class="fw-bold mb-3"><i class="fas fa-camera me-2 text-primary"></i> Über-uns-Bild</h6>
                          <form action="{{ url_for('dashboard_ueber_uns_bild_speichern') }}" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="d-flex align-items-center border rounded p-3">
                              {% if ueber_uns_bild %}
                              <img src="{{ ueber_uns_bild.pfad }}" alt="Über uns" class="me-3" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                              {% else %}
                              <div class="bg-light d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px; border-radius: 8px;">
                                <i class="fas fa-users text-muted fa-2x"></i>
                              </div>
                              {% endif %}
                              <div class="flex-grow-1">
                                <input type="file" class="form-control mb-2" name="ueber_uns_bild" accept="image/*">
                                <button type="submit" class="btn btn-sm btn-primary">
                                  <i class="fas fa-upload me-1"></i> Hochladen
                                </button>
                              </div>
                            </div>
                            <small class="text-muted d-block mt-2">Praxisbild für den "Über uns"-Bereich der Landingpage.</small>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Leistungen Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingServices">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices" aria-expanded="false" aria-controls="collapseServices">
                      <i class="fas fa-tooth me-2 text-primary"></i> Leistungsschwerpunkte ({{ leistungen|length if leistungen else 0 }})
                    </button>
                  </h2>
                  <div id="collapseServices" class="accordion-collapse collapse" aria-labelledby="headingServices" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <p class="text-muted mb-3">Wählen Sie die Leistungen aus, die Ihre Praxis anbietet. Diese werden auf Ihrer Landingpage angezeigt und für die Suche sowie den KI-Chatbot verwendet.</p>
                      
                      <!-- Leistungs-Kacheln Formular -->
                      <form action="{{ url_for('dashboard_leistungen_kacheln_speichern') }}" method="post" id="leistungen-kacheln-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        {% set aktive_slugs = [] %}
                        {% for leistung in leistungen %}
                          {% set _ = aktive_slugs.append(leistung.titel.lower().replace('ä', 'ae').replace('ö', 'oe').replace('ü', 'ue').replace(' ', '-')) %}
                        {% endfor %}
                        {% set aktive_schwerpunkte = praxis.leistungsschwerpunkte.split(',') if praxis and praxis.leistungsschwerpunkte else [] %}
                        
                        <div class="row g-3" id="leistungen-tiles">
                          {% set vordefinierte_leistungen = [
                            {'slug': 'implantologie', 'titel': 'Implantologie', 'icon': 'fas fa-teeth'},
                            {'slug': 'kieferorthopaedie', 'titel': 'Kieferorthopädie', 'icon': 'fas fa-teeth-open'},
                            {'slug': 'prophylaxe', 'titel': 'Prophylaxe', 'icon': 'fas fa-shield-alt'},
                            {'slug': 'aesthetische-zahnheilkunde', 'titel': 'Ästhetische Zahnheilkunde', 'icon': 'fas fa-smile'},
                            {'slug': 'kinderzahnheilkunde', 'titel': 'Kinderzahnheilkunde', 'icon': 'fas fa-baby'},
                            {'slug': 'parodontologie', 'titel': 'Parodontologie', 'icon': 'fas fa-tooth'},
                            {'slug': 'endodontie', 'titel': 'Endodontie', 'icon': 'fas fa-syringe'},
                            {'slug': 'oralchirurgie', 'titel': 'Oralchirurgie', 'icon': 'fas fa-user-md'},
                            {'slug': 'prothetik', 'titel': 'Prothetik', 'icon': 'fas fa-teeth'},
                            {'slug': 'angstpatienten', 'titel': 'Angstpatienten', 'icon': 'fas fa-heart'}
                          ] %}
                          
                          {% for leistung in vordefinierte_leistungen %}
                          <div class="col-6 col-md-4 col-xl-3">
                            <div class="leistung-tile card h-100 text-center {% if leistung.slug in aktive_schwerpunkte %}selected{% endif %}" 
                                 data-slug="{{ leistung.slug }}" 
                                 onclick="toggleLeistungTile(this)">
                              <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
                                <div class="leistung-icon mb-3">
                                  <i class="{{ leistung.icon }} fa-2x"></i>
                                </div>
                                <h6 class="card-title mb-0 small fw-bold">{{ leistung.titel }}</h6>
                                <div class="check-indicator mt-2">
                                  <i class="fas fa-check-circle"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                        
                        <input type="hidden" name="selected_leistungen" id="selected_leistungen_input" value="{{ praxis.leistungsschwerpunkte or '' }}">
                        
                        <div class="mt-4">
                          <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Leistungen speichern
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <style>
                .leistung-tile {
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid #e9ecef;
                    background: #fff;
                }
                .leistung-tile:hover {
                    border-color: #35bfd6;
                    transform: translateY(-3px);
                    box-shadow: 0 8px 25px rgba(53, 191, 214, 0.15);
                }
                .leistung-tile.selected {
                    border-color: #35bfd6;
                    background: linear-gradient(135deg, rgba(53, 191, 214, 0.1), rgba(42, 130, 148, 0.1));
                }
                .leistung-tile .leistung-icon {
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, rgba(53, 191, 214, 0.15), rgba(42, 130, 148, 0.15));
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #2a8294;
                    transition: all 0.3s ease;
                }
                .leistung-tile.selected .leistung-icon {
                    background: linear-gradient(135deg, #35bfd6, #2a8294);
                    color: #fff;
                }
                .leistung-tile .check-indicator {
                    opacity: 0;
                    color: #35bfd6;
                    transition: all 0.3s ease;
                    font-size: 1.2rem;
                }
                .leistung-tile.selected .check-indicator {
                    opacity: 1;
                }
                .leistung-tile .card-title {
                    color: #333;
                }
                .leistung-tile.selected .card-title {
                    color: #2a8294;
                }
                </style>
                
                <script>
                function toggleLeistungTile(tile) {
                    tile.classList.toggle('selected');
                    updateSelectedLeistungenInput();
                }
                
                function updateSelectedLeistungenInput() {
                    const selectedTiles = document.querySelectorAll('.leistung-tile.selected');
                    const slugs = Array.from(selectedTiles).map(tile => tile.dataset.slug);
                    document.getElementById('selected_leistungen_input').value = slugs.join(',');
                }
                
                document.addEventListener('DOMContentLoaded', function() {
                    // Nicht beim Laden aktualisieren - der Server-Wert bleibt erhalten
                    // updateSelectedLeistungenInput() würde den initialen Wert überschreiben
                    
                    // Formular-Submit validieren
                    const form = document.getElementById('leistungen-kacheln-form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            const selectedTiles = document.querySelectorAll('.leistung-tile.selected');
                            if (selectedTiles.length === 0) {
                                if (!confirm('Sie haben keine Leistungen ausgewählt. Möchten Sie wirklich alle Leistungen entfernen?')) {
                                    e.preventDefault();
                                    return false;
                                }
                            }
                            // Vor dem Submit die Werte aktualisieren
                            updateSelectedLeistungenInput();
                        });
                    }
                });
                </script>
                
                <!-- Team Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingTeam">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTeam" aria-expanded="false" aria-controls="collapseTeam">
                      <i class="fas fa-user-md me-2 text-primary"></i> Team ({{ team_mitglieder|length if team_mitglieder else 0 }})
                    </button>
                  </h2>
                  <div id="collapseTeam" class="accordion-collapse collapse" aria-labelledby="headingTeam" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <!-- Neues Teammitglied hinzufügen -->
                      <div class="mb-4">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#neuesTeamFormular">
                          <i class="fas fa-user-plus me-2"></i> Neues Teammitglied hinzufügen
                        </button>
                        <div class="collapse mt-3" id="neuesTeamFormular">
                          <div class="card border-0 bg-light">
                            <div class="card-body">
                              <form action="{{ url_for('dashboard_teammitglied_speichern') }}" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <label class="form-label small fw-bold"><i class="fas fa-user me-1 text-primary"></i> Name *</label>
                                    <input type="text" class="form-control" name="name" placeholder="z.B. Dr. Anna Schmidt" required>
                                  </div>
                                  <div class="col-md-6">
                                    <label class="form-label small fw-bold"><i class="fas fa-briefcase me-1 text-primary"></i> Position</label>
                                    <input type="text" class="form-control" name="position" placeholder="z.B. Zahnärztin, ZFA, Prophylaxe">
                                  </div>
                                  <div class="col-12">
                                    <label class="form-label small fw-bold"><i class="fas fa-align-left me-1 text-primary"></i> Beschreibung</label>
                                    <textarea class="form-control" name="beschreibung" rows="2" placeholder="Kurze Vorstellung der Person..."></textarea>
                                  </div>
                                  <div class="col-md-4">
                                    <label class="form-label small fw-bold"><i class="fas fa-graduation-cap me-1 text-warning"></i> Qualifikationen</label>
                                    <input type="text" class="form-control" name="qualifikationen" placeholder="z.B. Implantologie, Endodontie">
                                    <div class="form-text">Kommagetrennt eingeben</div>
                                  </div>
                                  <div class="col-md-4">
                                    <label class="form-label small fw-bold"><i class="fas fa-star me-1 text-success"></i> Schwerpunkte</label>
                                    <input type="text" class="form-control" name="schwerpunkte" placeholder="z.B. Ästhetik, Prophylaxe">
                                    <div class="form-text">Kommagetrennt eingeben</div>
                                  </div>
                                  <div class="col-md-4">
                                    <label class="form-label small fw-bold"><i class="fas fa-globe me-1 text-info"></i> Sprachen</label>
                                    <input type="text" class="form-control" name="sprachen" placeholder="z.B. Deutsch, Englisch">
                                    <div class="form-text">Kommagetrennt eingeben</div>
                                  </div>
                                  <div class="col-md-6">
                                    <label class="form-label small fw-bold"><i class="fas fa-camera me-1 text-primary"></i> Foto</label>
                                    <input type="file" class="form-control" name="bild" accept="image/*">
                                  </div>
                                  <div class="col-md-6 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                      <i class="fas fa-plus me-2"></i> Hinzufügen
                                    </button>
                                  </div>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Team-Mitglieder Liste -->
                      {% if team_mitglieder %}
                        <div class="accordion" id="teamAccordion">
                          {% for mitglied in team_mitglieder %}
                          <div class="accordion-item border-0 shadow-sm mb-2 rounded overflow-hidden">
                            <h2 class="accordion-header">
                              <button class="accordion-button collapsed py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#teamMitglied{{ mitglied.id }}" style="background: #f8f9fa;">
                                <div class="d-flex align-items-center w-100">
                                  {% if mitglied.bild_pfad %}
                                  <img src="{{ mitglied.bild_pfad }}" class="rounded-circle me-3 flex-shrink-0" width="45" height="45" style="object-fit: cover;" alt="{{ mitglied.name }}">
                                  {% else %}
                                  <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 45px; height: 45px;">
                                    <i class="fas fa-user"></i>
                                  </div>
                                  {% endif %}
                                  <div class="flex-grow-1">
                                    <span class="fw-bold">{{ mitglied.name }}</span>
                                    <span class="text-muted ms-2 small">{{ mitglied.position or 'Teammitglied' }}</span>
                                  </div>
                                  {% if mitglied.qualifikationen or mitglied.schwerpunkte or mitglied.sprachen %}
                                  <div class="me-3 d-none d-md-flex gap-1">
                                    {% if mitglied.qualifikationen %}<span class="badge bg-warning bg-opacity-10 text-warning"><i class="fas fa-graduation-cap"></i></span>{% endif %}
                                    {% if mitglied.schwerpunkte %}<span class="badge bg-success bg-opacity-10 text-success"><i class="fas fa-star"></i></span>{% endif %}
                                    {% if mitglied.sprachen %}<span class="badge bg-info bg-opacity-10 text-info"><i class="fas fa-globe"></i></span>{% endif %}
                                  </div>
                                  {% endif %}
                                </div>
                              </button>
                            </h2>
                            <div id="teamMitglied{{ mitglied.id }}" class="accordion-collapse collapse" data-bs-parent="#teamAccordion">
                              <div class="accordion-body pt-2">
                                <form action="{{ url_for('dashboard_teammitglied_speichern') }}" method="post" enctype="multipart/form-data">
                                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                  <input type="hidden" name="mitglied_id" value="{{ mitglied.id }}">
                                  <div class="row g-3">
                                    <div class="col-md-6">
                                      <label class="form-label small fw-bold"><i class="fas fa-user me-1 text-primary"></i> Name *</label>
                                      <input type="text" class="form-control form-control-sm" name="name" value="{{ mitglied.name }}" required>
                                    </div>
                                    <div class="col-md-6">
                                      <label class="form-label small fw-bold"><i class="fas fa-briefcase me-1 text-primary"></i> Position</label>
                                      <input type="text" class="form-control form-control-sm" name="position" value="{{ mitglied.position or '' }}">
                                    </div>
                                    <div class="col-12">
                                      <label class="form-label small fw-bold"><i class="fas fa-align-left me-1 text-primary"></i> Beschreibung</label>
                                      <textarea class="form-control form-control-sm" name="beschreibung" rows="2">{{ mitglied.beschreibung or '' }}</textarea>
                                    </div>
                                    <div class="col-md-4">
                                      <label class="form-label small fw-bold"><i class="fas fa-graduation-cap me-1 text-warning"></i> Qualifikationen</label>
                                      <input type="text" class="form-control form-control-sm" name="qualifikationen" value="{{ mitglied.qualifikationen or '' }}" placeholder="Kommagetrennt">
                                    </div>
                                    <div class="col-md-4">
                                      <label class="form-label small fw-bold"><i class="fas fa-star me-1 text-success"></i> Schwerpunkte</label>
                                      <input type="text" class="form-control form-control-sm" name="schwerpunkte" value="{{ mitglied.schwerpunkte or '' }}" placeholder="Kommagetrennt">
                                    </div>
                                    <div class="col-md-4">
                                      <label class="form-label small fw-bold"><i class="fas fa-globe me-1 text-info"></i> Sprachen</label>
                                      <input type="text" class="form-control form-control-sm" name="sprachen" value="{{ mitglied.sprachen or '' }}" placeholder="Kommagetrennt">
                                    </div>
                                    <div class="col-md-6">
                                      <label class="form-label small fw-bold"><i class="fas fa-camera me-1 text-primary"></i> Foto ändern</label>
                                      <input type="file" class="form-control form-control-sm" name="bild" accept="image/*">
                                      {% if mitglied.bild_pfad %}
                                      <div class="form-text text-success"><i class="fas fa-check me-1"></i>Foto vorhanden</div>
                                      {% endif %}
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end gap-2">
                                      <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                        <i class="fas fa-save me-1"></i> Speichern
                                      </button>
                                      <button type="button" class="btn btn-outline-danger btn-sm" onclick="if(confirm('Teammitglied wirklich löschen?')){document.getElementById('delete-team-{{ mitglied.id }}').submit();}">
                                        <i class="fas fa-trash"></i>
                                      </button>
                                    </div>
                                  </div>
                                </form>
                                <form id="delete-team-{{ mitglied.id }}" action="{{ url_for('dashboard_teammitglied_loeschen', mitglied_id=mitglied.id) }}" method="post" class="d-none">
                                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                </form>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="text-center text-muted py-4">
                          <i class="fas fa-users fa-2x mb-2 d-block"></i>
                          <p class="mb-0">Noch keine Teammitglieder hinzugefügt.</p>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <!-- Dentalberater - Patientensuche Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingDentalMatch">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDentalMatch" aria-expanded="false" aria-controls="collapseDentalMatch">
                      <i class="fas fa-robot me-2 text-primary"></i> Dentalberater - Patientensuche
                    </button>
                  </h2>
                  <div id="collapseDentalMatch" class="accordion-collapse collapse" aria-labelledby="headingDentalMatch" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <p class="text-muted mb-3">Diese Angaben helfen unserem KI-Assistenten, passende Patienten zu Ihrer Praxis zu vermitteln.</p>
                      
                      <form action="{{ url_for('dashboard_dental_match_speichern') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="angstpatientenfreundlich" id="angstpatientenfreundlich_lp" value="1" {% if praxis and praxis.angstpatientenfreundlich %}checked{% endif %}>
                              <label class="form-check-label" for="angstpatientenfreundlich_lp">
                                <i class="fas fa-heart me-1 text-danger"></i> Angstpatienten-freundlich
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="kinderfreundlich" id="kinderfreundlich_lp" value="1" {% if praxis and praxis.kinderfreundlich %}checked{% endif %}>
                              <label class="form-check-label" for="kinderfreundlich_lp">
                                <i class="fas fa-child me-1 text-info"></i> Kinderfreundlich
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="barrierefrei" id="barrierefrei_lp" value="1" {% if praxis and praxis.barrierefrei %}checked{% endif %}>
                              <label class="form-check-label" for="barrierefrei_lp">
                                <i class="fas fa-wheelchair me-1 text-success"></i> Barrierefrei
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="abendsprechstunde" id="abendsprechstunde_lp" value="1" {% if praxis and praxis.abendsprechstunde %}checked{% endif %}>
                              <label class="form-check-label" for="abendsprechstunde_lp">
                                <i class="fas fa-moon me-1 text-warning"></i> Abendsprechstunde
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="samstagssprechstunde" id="samstagssprechstunde_lp" value="1" {% if praxis and praxis.samstagssprechstunde %}checked{% endif %}>
                              <label class="form-check-label" for="samstagssprechstunde_lp">
                                <i class="fas fa-calendar-week me-1 text-primary"></i> Samstagssprechstunde
                              </label>
                            </div>
                          </div>
                          <div class="col-md-6 col-lg-4 mb-3">
                            <label for="sprachen_lp" class="form-label"><i class="fas fa-language me-1 text-secondary"></i> Sprachen</label>
                            <input type="text" class="form-control" id="sprachen_lp" name="sprachen" value="{{ praxis.sprachen if praxis and praxis.sprachen else 'Deutsch' }}" placeholder="z.B. Deutsch, Englisch, Türkisch">
                            <small class="text-muted">Kommagetrennt</small>
                          </div>
                        </div>
                        <div class="mt-3">
                          <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Dentalberater Einstellungen speichern
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <!-- Öffnungszeiten Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingHours">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHours" aria-expanded="false" aria-controls="collapseHours">
                      <i class="fas fa-clock me-2 text-primary"></i> Öffnungszeiten
                    </button>
                  </h2>
                  <div id="collapseHours" class="accordion-collapse collapse" aria-labelledby="headingHours" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <p class="text-muted mb-3">Geben Sie die Öffnungszeiten Ihrer Praxis ein. Diese werden auf Ihrer Landingpage angezeigt.</p>
                      
                      <form action="{{ url_for('dashboard_oeffnungszeiten_speichern') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                          {% set wochentage = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'] %}
                          {% for tag in wochentage %}
                          {% set oz = oeffnungszeiten_dict.get(tag) if oeffnungszeiten_dict else none %}
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ tag }}</label>
                            <div class="d-flex align-items-center gap-2">
                              <input type="time" class="form-control" name="oz_{{ tag|lower }}_von" 
                                     value="{{ oz.von.strftime('%H:%M') if oz and oz.von else '08:00' }}"
                                     {% if oz and oz.geschlossen %}disabled{% endif %}>
                              <span class="text-muted">-</span>
                              <input type="time" class="form-control" name="oz_{{ tag|lower }}_bis" 
                                     value="{{ oz.bis.strftime('%H:%M') if oz and oz.bis else '18:00' }}"
                                     {% if oz and oz.geschlossen %}disabled{% endif %}>
                              <div class="form-check ms-2">
                                <input class="form-check-input oeffnungszeit-toggle" type="checkbox" 
                                       name="oz_{{ tag|lower }}_geschlossen" id="oz_{{ tag|lower }}_geschlossen_lp"
                                       data-tag="{{ tag|lower }}"
                                       {% if oz and oz.geschlossen %}checked{% endif %}>
                                <label class="form-check-label small" for="oz_{{ tag|lower }}_geschlossen_lp">Geschlossen</label>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                        <div class="mt-3">
                          <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Öffnungszeiten speichern
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <!-- Kontakt Sektion -->
                <div class="accordion-item border-0 shadow-sm mb-3">
                  <h2 class="accordion-header" id="headingContact">
                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact" aria-expanded="false" aria-controls="collapseContact">
                      <i class="fas fa-map-marker-alt me-2 text-primary"></i> Kontakt & Anfahrt
                    </button>
                  </h2>
                  <div id="collapseContact" class="accordion-collapse collapse" aria-labelledby="headingContact" data-bs-parent="#landingpageAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="contactForm" class="form-label">Kontaktformular aktivieren</label>
                            <div class="form-check form-switch">
                              <input class="form-check-input" type="checkbox" id="contactForm" checked>
                              <label class="form-check-label" for="contactForm">Formular anzeigen</label>
                            </div>
                          </div>
                          <div class="mb-3">
                            <label for="contactMap" class="form-label">Karte anzeigen</label>
                            <div class="form-check form-switch">
                              <input class="form-check-input" type="checkbox" id="contactMap" checked>
                              <label class="form-check-label" for="contactMap">Google Maps einbinden</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="alert alert-info p-3 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Die Kontaktdaten werden aus Ihren <strong>Praxisdaten</strong> übernommen. Ändern Sie diese dort, um sie auf der Landingpage zu aktualisieren.</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
              </div>
              
                          </div>
          </div>
        </div>
        
        <!-- Praxisdaten Content -->
        <div id="praxisdaten-content" class="dashboard-content" {% if request.args.get('page') != 'praxisdaten' %}style="display: none;"{% endif %}>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-clinic-medical me-2 text-primary"></i>Praxisdaten
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i> Hier können Sie Ihre Praxisdaten verwalten und aktualisieren.
              </div>
              
              <form action="{{ url_for('dashboard_praxisdaten_speichern') }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row mb-4">
                  <div class="col-12 mb-3">
                    <h6 class="fw-bold">Praxisangaben</h6>
                  </div>
                  <div class="col-12 mb-3">
                    <label for="praxisname" class="form-label">Praxisname *</label>
                    <input type="text" class="form-control" id="praxisname" name="name" value="{{ praxis.name if praxis else '' }}" required>
                  </div>
                </div>
                
                <div class="row mb-4">
                  <div class="col-12 mb-3">
                    <h6 class="fw-bold">Kontaktdaten</h6>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="strasse" class="form-label">Straße und Hausnummer *</label>
                    <input type="text" class="form-control" id="strasse" name="strasse" value="{{ praxis.strasse if praxis else '' }}" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="plz" class="form-label">PLZ *</label>
                    <input type="text" class="form-control" id="plz" name="plz" value="{{ praxis.plz if praxis else '' }}" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="ort" class="form-label">Ort *</label>
                    <input type="text" class="form-control" id="ort" name="stadt" value="{{ praxis.stadt if praxis else '' }}" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="telefon" class="form-label">Telefon *</label>
                    <input type="tel" class="form-control" id="telefon" name="telefon" value="{{ praxis.telefon if praxis else '' }}" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">E-Mail *</label>
                    <input type="email" class="form-control" id="email" name="email" value="{{ praxis.email if praxis else '' }}" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="webseite" class="form-label">Webseite</label>
                    <input type="url" class="form-control" id="webseite" name="website" value="{{ praxis.webseite if praxis else '' }}">
                  </div>
                </div>
                
                <div class="d-flex justify-content-end">
                  <button type="reset" class="btn btn-light me-2">Zurücksetzen</button>
                  <button type="submit" class="btn btn-primary">Praxisdaten speichern</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Passwort ändern Card -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-key me-2 text-primary"></i>Passwort ändern
              </h5>
            </div>
            <div class="card-body">
              <form action="{{ url_for('dashboard_passwort_aendern') }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row">
                  <div class="col-md-6 col-lg-4 mb-3">
                    <label for="aktuelles_passwort" class="form-label">Aktuelles Passwort *</label>
                    <input type="password" class="form-control" id="aktuelles_passwort" name="aktuelles_passwort" required>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 col-lg-4 mb-3">
                    <label for="neues_passwort" class="form-label">Neues Passwort *</label>
                    <input type="password" class="form-control" id="neues_passwort" name="neues_passwort" required minlength="8">
                    <small class="text-muted">Mindestens 8 Zeichen</small>
                  </div>
                  <div class="col-md-6 col-lg-4 mb-3">
                    <label for="neues_passwort_bestaetigen" class="form-label">Neues Passwort bestätigen *</label>
                    <input type="password" class="form-control" id="neues_passwort_bestaetigen" name="neues_passwort_bestaetigen" required minlength="8">
                  </div>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Passwort ändern
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Terminverwaltung Content -->
        <div id="termine-content" class="dashboard-content" {% if request.args.get('page') != 'termine' %}style="display: none;"{% endif %}>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-calendar-alt me-2 text-primary"></i>Terminbuchung auf der Landingpage
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i> Wählen Sie, wie Patienten über Ihre Landingpage Termine buchen können.
              </div>
              
              <form action="/dashboard/terminbuchung" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="row g-4">
                  <!-- Buchungsmodus Auswahl -->
                  <div class="col-12">
                    <h6 class="fw-bold mb-3">Buchungsmethode</h6>
                    <div class="row g-3">
                      <!-- Option 1: Dentalax Kalender -->
                      <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-2 booking-mode-card {% if praxis and praxis.terminbuchung_modus == 'dashboard' %}border-primary shadow{% endif %}" id="card-dashboard" data-mode="dashboard" style="cursor: pointer;">
                          <div class="card-body p-4">
                            <input class="form-check-input visually-hidden" type="radio" name="terminbuchung_modus" id="modus_dashboard" value="dashboard" {% if not praxis or praxis.terminbuchung_modus == 'dashboard' %}checked{% endif %}>
                            <div class="text-center mb-3">
                              <div class="mx-auto mb-3" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(63, 191, 216, 0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-check fa-lg text-primary"></i>
                              </div>
                              <h6 class="fw-bold mb-1 text-dark">Dentalax Kalender</h6>
                              <span class="badge bg-primary text-white small">Empfohlen</span>
                            </div>
                            <ul class="list-unstyled small mb-0 text-dark">
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Online-Terminbuchung auf Ihrer Praxisseite</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Automatische oder manuelle Bestätigung</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>24h-Erinnerungsmails an Patienten</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Stammpatientenkartei mit Recall-System</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Tages- & Timeline-Ansicht</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Wiederkehrende Termine</li>
                              <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Verfügbarkeiten & Behandlungsarten</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Option 2: Kontaktformular -->
                      <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-2 booking-mode-card {% if praxis and praxis.terminbuchung_modus == 'formular' %}border-primary shadow{% endif %}" id="card-formular" data-mode="formular" style="cursor: pointer;">
                          <div class="card-body p-4">
                            <input class="form-check-input visually-hidden" type="radio" name="terminbuchung_modus" id="modus_formular" value="formular" {% if praxis and praxis.terminbuchung_modus == 'formular' %}checked{% endif %}>
                            <div class="text-center mb-3">
                              <div class="mx-auto mb-3" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(40, 167, 69, 0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-envelope fa-lg text-success"></i>
                              </div>
                              <h6 class="fw-bold mb-1 text-dark">Kontaktformular</h6>
                              <span class="badge bg-success bg-opacity-10 text-success small">Einfach</span>
                            </div>
                            <ul class="list-unstyled small mb-0 text-dark">
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Anfragen direkt an Ihre E-Mail-Adresse</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Patient gibt Name, E-Mail & Wunschtermin an</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Kein eigener Kalender nötig</li>
                              <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Ideal für manuelle Terminkoordination</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Option 3: Externer Link -->
                      <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-2 booking-mode-card {% if praxis and praxis.terminbuchung_modus == 'redirect' %}border-primary shadow{% endif %}" id="card-redirect" data-mode="redirect" style="cursor: pointer;">
                          <div class="card-body p-4">
                            <input class="form-check-input visually-hidden" type="radio" name="terminbuchung_modus" id="modus_redirect" value="redirect" {% if praxis and praxis.terminbuchung_modus == 'redirect' %}checked{% endif %}>
                            <div class="text-center mb-3">
                              <div class="mx-auto mb-3" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(111, 66, 193, 0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-external-link-alt fa-lg" style="color: #6f42c1;"></i>
                              </div>
                              <h6 class="fw-bold mb-1 text-dark">Externer Link</h6>
                              <span class="badge bg-secondary bg-opacity-10 text-secondary small">Flexibel</span>
                            </div>
                            <ul class="list-unstyled small mb-0 text-dark">
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Weiterleitung zu Doctolib, Jameda & Co.</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Alle Buchungen in einem System</li>
                              <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Volle Flexibilität mit Ihrem Tool</li>
                              <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Einfache Einrichtung per URL</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Externe URL Eingabe (nur bei redirect) -->
                  <div class="col-12" id="url-eingabe" {% if not praxis or praxis.terminbuchung_modus != 'redirect' %}style="display: none;"{% endif %}>
                    <div class="card bg-light border-0">
                      <div class="card-body">
                        <label for="terminbuchung_url" class="form-label fw-bold">
                          <i class="fas fa-link me-1"></i> Externe Buchungs-URL
                        </label>
                        <input type="url" class="form-control" id="terminbuchung_url" name="terminbuchung_url" 
                               placeholder="https://www.doctolib.de/zahnarzt/ihre-praxis" 
                               value="{{ praxis.terminbuchung_url if praxis and praxis.terminbuchung_url else '' }}">
                        <div class="form-text">Geben Sie den vollständigen Link zu Ihrem externen Buchungssystem ein (z.B. Doctolib, Jameda, eigene Website)</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-12">
                    <div class="d-flex justify-content-end">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i> Terminbuchung speichern
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="terminbuchung_modus"]');
            const urlEingabe = document.getElementById('url-eingabe');
            const cards = {
              'dashboard': document.getElementById('card-dashboard'),
              'formular': document.getElementById('card-formular'),
              'redirect': document.getElementById('card-redirect')
            };
            
            function updateCards() {
              Object.values(cards).forEach(card => {
                if (card) {
                  card.classList.remove('border-primary', 'shadow');
                }
              });
              radioButtons.forEach(radio => {
                if (radio.checked && cards[radio.value]) {
                  cards[radio.value].classList.add('border-primary', 'shadow');
                }
                if (radio.value === 'redirect' && radio.checked) {
                  urlEingabe.style.display = 'block';
                } else if (radio.value !== 'redirect' && radio.checked) {
                  urlEingabe.style.display = 'none';
                }
              });
            }
            
            radioButtons.forEach(radio => {
              radio.addEventListener('change', updateCards);
            });
            
            document.querySelectorAll('.booking-mode-card').forEach(card => {
              card.addEventListener('click', function() {
                const mode = this.getAttribute('data-mode');
                const radio = document.getElementById('modus_' + mode);
                if (radio) {
                  radio.checked = true;
                  radio.dispatchEvent(new Event('change'));
                }
              });
            });
          });
        </script>
        
        <!-- Bewertungen Content -->
        <div id="bewertungen-content" class="dashboard-content" {% if request.args.get('page') != 'bewertungen' %}style="display: none;"{% endif %}>
          
          <!-- Google Bewertungen Integration -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="card-title m-0 fw-bold">
                <svg class="me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Google Bewertungen
              </h5>
              {% if praxis.google_place_id and praxis.google_rating %}
              <div class="d-flex align-items-center gap-2">
                <span class="text-warning">
                  {% for i in range(1, 6) %}
                    {% if praxis.google_rating >= i %}
                      <i class="fas fa-star"></i>
                    {% elif praxis.google_rating >= i - 0.5 %}
                      <i class="fas fa-star-half-alt"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                </span>
                <span class="fw-bold">{{ praxis.google_rating }}</span>
                <span class="text-muted">({{ praxis.google_review_count or 0 }} Bewertungen)</span>
              </div>
              {% endif %}
            </div>
            <div class="card-body">
              {% if praxis.google_place_id %}
              <!-- Verbundener Status -->
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="d-flex align-items-center mb-3">
                    <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; min-width: 48px;">
                      <i class="fas fa-check-circle text-success fa-lg"></i>
                    </div>
                    <div>
                      <h6 class="mb-0 fw-bold text-success">Verbunden</h6>
                      <small class="text-muted">Place ID: {{ praxis.google_place_id[:20] }}...</small>
                    </div>
                  </div>
                  {% if praxis.google_sync_datum %}
                  <p class="text-muted small mb-2">
                    <i class="fas fa-sync-alt me-1"></i>Letzte Synchronisierung: {{ praxis.google_sync_datum.strftime('%d.%m.%Y %H:%M') }} Uhr
                  </p>
                  {% endif %}
                  {% if praxis.google_maps_url %}
                  <a href="{{ praxis.google_maps_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Google-Profil ansehen
                  </a>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  {% if praxis.google_rating %}
                  <div class="text-center p-4 bg-light rounded">
                    <div class="display-4 fw-bold text-primary mb-1">{{ praxis.google_rating }}</div>
                    <div class="text-warning h4 mb-2">
                      {% for i in range(1, 6) %}
                        {% if praxis.google_rating >= i %}
                          <i class="fas fa-star"></i>
                        {% elif praxis.google_rating >= i - 0.5 %}
                          <i class="fas fa-star-half-alt"></i>
                        {% else %}
                          <i class="far fa-star"></i>
                        {% endif %}
                      {% endfor %}
                    </div>
                    <p class="text-muted mb-0">{{ praxis.google_review_count or 0 }} Google-Bewertungen</p>
                  </div>
                  {% else %}
                  <div class="text-center p-4 bg-light rounded">
                    <p class="text-muted mb-2">Noch nicht synchronisiert</p>
                    <button type="button" class="btn btn-primary btn-sm" id="btn-google-sync">
                      <i class="fas fa-sync-alt me-1"></i>Jetzt synchronisieren
                    </button>
                  </div>
                  {% endif %}
                </div>
              </div>
              <hr>
              <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-google-sync-refresh">
                  <i class="fas fa-sync-alt me-1"></i>Bewertungen aktualisieren
                </button>
                <form action="{{ url_for('dashboard_google_place_id') }}" method="POST" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="google_place_id" value="">
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Möchten Sie die Google-Verknüpfung wirklich entfernen?')">
                    <i class="fas fa-unlink me-1"></i>Verknüpfung entfernen
                  </button>
                </form>
              </div>
              {% else %}
              <!-- Noch nicht verbunden -->
              <div class="text-center py-3">
                <div class="mb-3">
                  <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                  </div>
                </div>
                <h5 class="fw-bold mb-2">Google-Bewertungen verknüpfen</h5>
                <p class="text-muted mb-4">Zeigen Sie Ihre Google-Bewertungen automatisch auf Ihrer Landingpage und in den Suchergebnissen an.</p>
                
                <div class="row justify-content-center">
                  <div class="col-md-8">
                    <!-- Suche nach Praxis -->
                    <div class="mb-3">
                      <label class="form-label fw-medium">Praxis auf Google suchen</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="google-search-query" placeholder="{{ praxis.name }} {{ praxis.stadt }}" value="{{ praxis.name }} {{ praxis.stadt }}">
                        <button type="button" class="btn btn-primary" id="btn-google-search">
                          <i class="fas fa-search me-1"></i>Suchen
                        </button>
                      </div>
                    </div>
                    
                    <!-- Suchergebnisse -->
                    <div id="google-search-results" class="mb-3" style="display: none;"></div>
                    
                    <!-- Oder direkt Place ID eingeben -->
                    <div class="text-center my-3">
                      <small class="text-muted">— oder Place ID direkt eingeben —</small>
                    </div>
                    <form action="{{ url_for('dashboard_google_place_id') }}" method="POST">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <div class="input-group">
                        <input type="text" class="form-control" name="google_place_id" id="google-place-id-input" placeholder="z.B. ChIJ...">
                        <button type="submit" class="btn btn-outline-primary">
                          <i class="fas fa-link me-1"></i>Verknüpfen
                        </button>
                      </div>
                      <small class="form-text text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>Die Place ID finden Sie in Ihrem <a href="https://www.google.com/maps" target="_blank">Google Maps</a> Profil oder über die Suche oben.
                      </small>
                    </form>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Google Sync & Search Script -->
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            var syncBtn = document.getElementById('btn-google-sync');
            var syncRefreshBtn = document.getElementById('btn-google-sync-refresh');
            var searchBtn = document.getElementById('btn-google-search');
            
            function doSync(btn) {
              if (!btn) return;
              var origText = btn.innerHTML;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Synchronisiere...';
              btn.disabled = true;
              
              fetch('{{ url_for("dashboard_google_sync") }}', {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'csrf_token={{ csrf_token() }}'
              })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                if (data.success) {
                  location.reload();
                } else {
                  alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                  btn.innerHTML = origText;
                  btn.disabled = false;
                }
              })
              .catch(function() {
                alert('Netzwerkfehler bei der Synchronisierung.');
                btn.innerHTML = origText;
                btn.disabled = false;
              });
            }
            
            if (syncBtn) syncBtn.addEventListener('click', function() { doSync(syncBtn); });
            if (syncRefreshBtn) syncRefreshBtn.addEventListener('click', function() { doSync(syncRefreshBtn); });
            
            if (searchBtn) {
              searchBtn.addEventListener('click', function() {
                var query = document.getElementById('google-search-query').value.trim();
                if (!query) return;
                
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suche...';
                searchBtn.disabled = true;
                
                var formData = new FormData();
                formData.append('csrf_token', '{{ csrf_token() }}');
                formData.append('query', query);
                
                fetch('{{ url_for("dashboard_google_suche") }}', {
                  method: 'POST',
                  headers: { 'X-Requested-With': 'XMLHttpRequest' },
                  body: formData
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                  var container = document.getElementById('google-search-results');
                  container.style.display = 'block';
                  
                  if (data.success && data.results && data.results.length > 0) {
                    var html = '<div class="list-group">';
                    data.results.forEach(function(place) {
                      var stars = '';
                      if (place.rating) {
                        for (var i = 1; i <= 5; i++) {
                          if (place.rating >= i) stars += '<i class="fas fa-star text-warning"></i>';
                          else if (place.rating >= i - 0.5) stars += '<i class="fas fa-star-half-alt text-warning"></i>';
                          else stars += '<i class="far fa-star text-warning"></i>';
                        }
                      }
                      html += '<div class="list-group-item list-group-item-action p-3">' +
                        '<div class="d-flex justify-content-between align-items-start">' +
                          '<div>' +
                            '<h6 class="mb-1 fw-bold">' + place.name + '</h6>' +
                            '<small class="text-muted">' + place.address + '</small>' +
                            (place.rating ? '<br><span class="small">' + stars + ' <strong>' + place.rating + '</strong> (' + (place.review_count || 0) + ' Bewertungen)</span>' : '') +
                          '</div>' +
                          '<button type="button" class="btn btn-sm btn-primary ms-2 btn-select-place" data-place-id="' + place.place_id + '">' +
                            '<i class="fas fa-check me-1"></i>Auswählen' +
                          '</button>' +
                        '</div>' +
                      '</div>';
                    });
                    html += '</div>';
                    container.innerHTML = html;
                    
                    container.querySelectorAll('.btn-select-place').forEach(function(btn) {
                      btn.addEventListener('click', function() {
                        var placeId = this.getAttribute('data-place-id');
                        document.getElementById('google-place-id-input').value = placeId;
                        document.getElementById('google-place-id-input').closest('form').submit();
                      });
                    });
                  } else {
                    container.innerHTML = '<div class="alert alert-warning mb-0"><i class="fas fa-info-circle me-2"></i>Keine Ergebnisse gefunden. Versuchen Sie einen anderen Suchbegriff.</div>';
                  }
                  
                  searchBtn.innerHTML = '<i class="fas fa-search me-1"></i>Suchen';
                  searchBtn.disabled = false;
                })
                .catch(function() {
                  alert('Fehler bei der Suche.');
                  searchBtn.innerHTML = '<i class="fas fa-search me-1"></i>Suchen';
                  searchBtn.disabled = false;
                });
              });
            }
          });
          </script>

          <!-- Info-Banner -->
          <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Hinweis:</strong> Patienten können auf Ihrer Landingpage selbst Bewertungen abgeben. Diese erscheinen hier zur Freigabe.
          </div>
          
          <!-- Statistik -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-chart-bar me-2 text-primary"></i>Bewertungsübersicht
              </h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                {% set ausstehend = bewertungen|selectattr('status', 'eq', 'ausstehend')|list|length if bewertungen else 0 %}
                {% set freigegeben = bewertungen|selectattr('status', 'eq', 'freigegeben')|list|length if bewertungen else 0 %}
                {% set abgelehnt = bewertungen|selectattr('status', 'eq', 'abgelehnt')|list|length if bewertungen else 0 %}
                <div class="col-md-4">
                  <div class="p-3 bg-warning bg-opacity-10 rounded">
                    <h3 class="fw-bold text-warning mb-0">{{ ausstehend }}</h3>
                    <small class="text-muted">Ausstehend</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 bg-success bg-opacity-10 rounded">
                    <h3 class="fw-bold text-success mb-0">{{ freigegeben }}</h3>
                    <small class="text-muted">Freigegeben</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 bg-danger bg-opacity-10 rounded">
                    <h3 class="fw-bold text-danger mb-0">{{ abgelehnt }}</h3>
                    <small class="text-muted">Abgelehnt</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Bewertungen Liste -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-star me-2 text-primary"></i>Alle Bewertungen
              </h5>
              <div class="d-flex align-items-center">
                {% if bewertungen and bewertungen|length > 0 %}
                {% set freigegebene = bewertungen|selectattr('status', 'eq', 'freigegeben')|list %}
                {% if freigegebene|length > 0 %}
                {% set avg = (freigegebene|sum(attribute='bewertung') / freigegebene|length)|round(1) %}
                <div class="me-3">
                  <span class="fw-bold fs-4 me-2">{{ avg }}</span>
                  {% for i in range(1, 6) %}
                    {% if i <= avg|int %}
                    <i class="fas fa-star text-warning"></i>
                    {% elif i - avg < 1 and i - avg > 0 %}
                    <i class="fas fa-star-half-alt text-warning"></i>
                    {% else %}
                    <i class="far fa-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
                <span class="badge bg-primary">{{ bewertungen|length }} Bewertungen</span>
                {% else %}
                <span class="badge bg-secondary">Keine Bewertungen</span>
                {% endif %}
              </div>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush">
                {% if bewertungen and bewertungen|length > 0 %}
                  {% for b in bewertungen %}
                  <div class="list-group-item p-4 {% if b.status == 'ausstehend' %}bg-warning bg-opacity-10{% elif b.status == 'abgelehnt' %}bg-danger bg-opacity-10{% endif %}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center">
                        {% for i in range(1, 6) %}
                          {% if i <= b.bewertung %}
                          <i class="fas fa-star text-warning"></i>
                          {% else %}
                          <i class="far fa-star text-warning"></i>
                          {% endif %}
                        {% endfor %}
                        <span class="ms-2 fw-bold">{{ b.bewertung }}.0</span>
                        
                        {% if b.status == 'ausstehend' %}
                        <span class="badge bg-warning text-dark ms-2">Ausstehend</span>
                        {% elif b.status == 'freigegeben' %}
                        <span class="badge bg-success ms-2">Freigegeben</span>
                        {% elif b.status == 'abgelehnt' %}
                        <span class="badge bg-danger ms-2">Abgelehnt</span>
                        {% endif %}
                        
                        {% if b.quelle == 'patient' %}
                        <span class="badge bg-info ms-1">Patient</span>
                        {% elif b.quelle == 'dashboard' %}
                        <span class="badge bg-secondary ms-1">Manuell</span>
                        {% endif %}
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">{{ b.datum.strftime('%d.%m.%Y') if b.datum else 'Kürzlich' }}</small>
                        
                        {% if b.status == 'ausstehend' %}
                        <form action="{{ url_for('dashboard_bewertung_freigeben', bewertung_id=b.id) }}" method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="btn btn-sm btn-success" title="Freigeben">
                            <i class="fas fa-check"></i>
                          </button>
                        </form>
                        <form action="{{ url_for('dashboard_bewertung_ablehnen', bewertung_id=b.id) }}" method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="btn btn-sm btn-outline-danger" title="Ablehnen">
                            <i class="fas fa-times"></i>
                          </button>
                        </form>
                        {% endif %}
                        
                        <form action="{{ url_for('dashboard_bewertung_loeschen', bewertung_id=b.id) }}" method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bewertung wirklich löschen?')" title="Löschen">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                    <h6 class="mb-1">{{ b.name or 'Anonym' }}</h6>
                    <p class="mb-0">{{ b.text or 'Kein Bewertungstext' }}</p>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="list-group-item p-4 text-center">
                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                    <p class="mb-0 text-muted">Noch keine Bewertungen vorhanden. Patienten können auf Ihrer Landingpage Bewertungen abgeben.</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Plan & Abrechnung Content -->
        <div id="abrechnung-content" class="dashboard-content" {% if request.args.get('page') != 'abrechnung' %}style="display: none;"{% endif %}>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-credit-card me-2 text-primary"></i>Plan & Abrechnung
              </h5>
            </div>
            <div class="card-body">
              {% if request.args.get('success') %}
              <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                <i class="fas fa-check-circle me-2"></i> Vielen Dank! Ihr Paket wurde erfolgreich aktiviert.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              {% endif %}
              
              {% if request.args.get('canceled') %}
              <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
                <i class="fas fa-info-circle me-2"></i> Der Checkout wurde abgebrochen. Sie können jederzeit erneut upgraden.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              {% endif %}
              
              {% set current_paket = praxis.paket|lower if praxis and praxis.paket else 'basic' %}
              
              <div class="alert {% if current_paket == 'premiumplus' %}alert-success{% elif current_paket == 'premium' %}alert-info{% else %}alert-secondary{% endif %} mb-4" role="alert">
                <div class="d-flex align-items-center">
                  <div class="me-3 fs-3">
                    {% if current_paket == 'premiumplus' %}
                    <i class="fas fa-crown text-warning"></i>
                    {% elif current_paket == 'premium' %}
                    <i class="fas fa-star text-primary"></i>
                    {% else %}
                    <i class="fas fa-check-circle"></i>
                    {% endif %}
                  </div>
                  <div>
                    <h5 class="alert-heading mb-1">Ihr aktuelles Paket: 
                      {% if current_paket == 'premiumplus' %}PremiumPlus{% elif current_paket == 'premium' %}Premium{% else %}Basic (kostenlos){% endif %}
                    </h5>
                    <p class="mb-0">
                      {% if praxis and praxis.paket_aktiv_bis %}
                        Gültig bis: {{ praxis.paket_aktiv_bis.strftime('%d.%m.%Y') }}
                        {% if praxis.stripe_subscription_status == 'cancel_at_period_end' %}
                        <span class="badge bg-warning text-dark ms-2">Kündigung zum Laufzeitende</span>
                        {% endif %}
                      {% elif current_paket == 'basic' %}
                        Upgraden Sie für Premium-Funktionen
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-12 mb-3 d-flex justify-content-between align-items-center flex-wrap">
                  <h6 class="fw-bold mb-0">Verfügbare Pakete</h6>
                  <div class="bg-light shadow-sm rounded-pill px-3 py-2 d-inline-flex align-items-center" style="gap: 0.75rem;">
                    <span class="fw-medium small" style="color: var(--dental-dark);">Monatlich</span>
                    <div class="form-check form-switch m-0">
                      <input class="form-check-input" type="checkbox" id="zahlweiseSwitchDashboard">
                    </div>
                    <label class="fw-medium small" for="zahlweiseSwitchDashboard" style="color: var(--dental-dark);">
                      Jährlich <span class="badge bg-success bg-opacity-10 text-success fw-normal" style="font-size: 0.7rem;">10% sparen</span>
                    </label>
                  </div>
                </div>
                
                <!-- Basis -->
                <div class="col-lg-4 mb-3">
                  <div class="card h-100 border-0 {% if current_paket == 'basic' or current_paket == 'basis' %}border-primary border-2{% else %}bg-light{% endif %}">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title fw-bold mb-0">Basis</h5>
                        <span class="badge rounded-pill text-bg-light">Kostenlos</span>
                      </div>
                      <h6 class="fw-bold mb-3">
                        <span class="fs-2" style="color: var(--dental-primary, #3fbfd8);">0 €</span>
                      </h6>
                      <p class="text-muted small mb-3">Der ideale Einstieg für Ihre Praxis</p>
                      <ul class="list-unstyled mb-4">
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Lokale Sichtbarkeit auf Google</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Teilnahme am Bewertungssystem</span>
                        </li>
                      </ul>
                      {% if current_paket == 'basic' or current_paket == 'basis' %}
                      <div class="d-grid">
                        <button class="btn btn-outline-secondary rounded-pill" disabled>Aktueller Plan</button>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <!-- Premium -->
                <div class="col-lg-4 mb-3">
                  <div class="card h-100 border-2 {% if current_paket == 'premium' %}border-primary{% else %}border-primary shadow{% endif %} position-relative">
                    {% if current_paket != 'premium' %}
                    <div class="position-absolute top-0 end-0 translate-middle-y me-4">
                      <div class="badge rounded-pill text-bg-primary px-3 py-2 shadow-sm">Beliebt</div>
                    </div>
                    {% endif %}
                    <div class="card-body">
                      <h5 class="card-title fw-bold mb-3">Premium</h5>
                      <h6 class="fw-bold mb-3">
                        <span class="fs-2" style="color: var(--dental-primary, #3fbfd8);">
                          <span class="monatlich-preis">59 €</span>
                          <span class="jaehrlich-preis d-none">636 €</span>
                        </span>
                        <span class="text-muted fw-normal fs-6 monatlich-preis">/ Monat</span>
                        <span class="text-muted fw-normal fs-6 jaehrlich-preis d-none">/ Jahr</span>
                      </h6>
                      <p class="text-muted small mb-3 monatlich-preis">oder 636 €/Jahr <span class="badge bg-success bg-opacity-10 text-success fw-normal">10% Ersparnis</span></p>
                      <p class="text-muted small mb-3 jaehrlich-preis d-none">entspricht 53 €/Monat</p>
                      <ul class="list-unstyled mb-4">
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Eigene moderne Landingpage</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Sichtbarkeit auf Google und Dentalax</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Teilnahme am KI Chat Empfehlung</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Dashboard mit Tracking-Funktionen</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Neue Patienten gewinnen</span>
                        </li>
                      </ul>
                      {% if current_paket == 'premium' %}
                      <div class="d-grid">
                        <button class="btn btn-outline-primary rounded-pill" disabled>Aktueller Plan</button>
                      </div>
                      {% elif current_paket == 'premiumplus' %}
                      <p class="text-muted small text-center mb-0">Downgrade zum Laufzeitende möglich</p>
                      {% else %}
                      <div class="d-grid">
                        <form action="{{ url_for('api_subscription_upgrade') }}" method="post">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="paket" value="premium">
                          <input type="hidden" name="zahlweise" value="monatlich" class="hidden-zahlweise">
                          <button type="submit" class="btn btn-primary rounded-pill w-100">Premium wählen</button>
                        </form>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <!-- PremiumPlus -->
                <div class="col-lg-4 mb-3">
                  <div class="card h-100 border-0 {% if current_paket == 'premiumplus' %}border-warning border-2{% else %}shadow-sm{% endif %}">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title fw-bold mb-0">PremiumPlus</h5>
                        <span class="badge rounded-pill bg-light text-dark">Top</span>
                      </div>
                      <h6 class="fw-bold mb-3">
                        <span class="fs-2" style="color: var(--dental-primary, #3fbfd8);">
                          <span class="monatlich-preis">89 €</span>
                          <span class="jaehrlich-preis d-none">960 €</span>
                        </span>
                        <span class="text-muted fw-normal fs-6 monatlich-preis">/ Monat</span>
                        <span class="text-muted fw-normal fs-6 jaehrlich-preis d-none">/ Jahr</span>
                      </h6>
                      <p class="text-muted small mb-3 monatlich-preis">oder 960 €/Jahr <span class="badge bg-success bg-opacity-10 text-success fw-normal">10% Ersparnis</span></p>
                      <p class="text-muted small mb-3 jaehrlich-preis d-none">entspricht 80 €/Monat</p>
                      <ul class="list-unstyled mb-4">
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Alle Vorteile von Premium</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Eigene Jobanzeigen veröffentlichen</span>
                        </li>
                        <li class="d-flex align-items-center py-1">
                          <div class="d-inline-flex align-items-center justify-content-center rounded-circle flex-shrink-0 me-2" style="width: 24px; height: 24px; background-color: rgba(63, 191, 216, 0.1);">
                            <i class="fas fa-check text-primary small"></i>
                          </div>
                          <span>Zugang zu exklusiven Bewerbungen</span>
                        </li>
                      </ul>
                      {% if current_paket == 'premiumplus' %}
                      <div class="d-grid">
                        <button class="btn btn-outline-primary rounded-pill" disabled>Aktueller Plan</button>
                      </div>
                      {% else %}
                      <div class="d-grid">
                        <form action="{{ url_for('api_subscription_upgrade') }}" method="post">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="paket" value="premiumplus">
                          <input type="hidden" name="zahlweise" value="monatlich" class="hidden-zahlweise">
                          <button type="submit" class="btn btn-primary rounded-pill w-100">PremiumPlus wählen</button>
                        </form>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              {% if current_paket != 'basic' and praxis and praxis.stripe_customer_id %}
              <hr class="my-4">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="fw-bold mb-3">Abonnement verwalten</h6>
                  <p class="text-muted small mb-3">Über das Stripe-Kundenportal können Sie Ihre Zahlungsmethode ändern, Rechnungen einsehen und Ihr Abo verwalten.</p>
                  <form action="{{ url_for('api_subscription_portal') }}" method="post" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-primary">
                      <i class="fas fa-external-link-alt me-1"></i> Kundenportal öffnen
                    </button>
                  </form>
                </div>
                <div class="col-md-6">
                  <h6 class="fw-bold mb-3">Abonnement kündigen</h6>
                  <p class="text-muted small mb-3">Sie können Ihr Abo zum Ende der aktuellen Laufzeit kündigen. Ihre Premium-Funktionen bleiben bis dahin aktiv.</p>
                  {% if not praxis or praxis.stripe_subscription_status != 'cancel_at_period_end' %}
                  <form action="{{ url_for('api_subscription_cancel') }}" method="post" class="d-inline" onsubmit="return confirm('Möchten Sie Ihr Abonnement wirklich zum Ende der Laufzeit kündigen?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="at_period_end" value="true">
                    <button type="submit" class="btn btn-outline-danger">
                      <i class="fas fa-times-circle me-1"></i> Abo kündigen
                    </button>
                  </form>
                  {% else %}
                  <span class="badge bg-warning text-dark">Kündigung bereits vorgemerkt</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Stellenangebote Content -->
        <div id="stellenangebote-content" class="dashboard-content" {% if request.args.get('page') != 'stellenangebote' %}style="display: none;"{% endif %}>
          {% set current_paket = praxis.paket|lower if praxis and praxis.paket else 'basic' %}
          
          {% if current_paket != 'premiumplus' %}
          <!-- Upgrade-Hinweis für nicht-PremiumPlus Nutzer -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center py-5">
              <div class="mb-4">
                <i class="fas fa-crown fa-4x text-warning"></i>
              </div>
              <h4 class="fw-bold mb-3">Stellenangebote sind ein PremiumPlus-Feature</h4>
              <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
                Mit PremiumPlus können Sie unbegrenzt Stellenangebote schalten und qualifizierte Bewerber direkt über Ihre Praxisseite erreichen. Finden Sie ZFAs, ZMPs und andere Fachkräfte für Ihre Praxis.
              </p>
              <div class="d-flex justify-content-center gap-3">
                <a href="/zahnarzt-dashboard?page=abrechnung" class="btn btn-warning btn-lg">
                  <i class="fas fa-arrow-up me-2"></i> Jetzt auf PremiumPlus upgraden
                </a>
              </div>
              <p class="text-muted small mt-4 mb-0">
                Ab nur 89€/Monat - inklusive aller Premium-Funktionen
              </p>
            </div>
          </div>
          {% else %}
          <!-- PremiumPlus Nutzer: Stellenangebote verwalten -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-briefcase me-2 text-primary"></i>Stellenangebote ({{ stellenangebote|length if stellenangebote else 0 }})
              </h5>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#neuesStellenangebotModal">
                <i class="fas fa-plus me-1"></i> Neues Stellenangebot
              </button>
            </div>
            <div class="card-body">
              {% if stellenangebote and stellenangebote|length > 0 %}
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Position</th>
                      <th>Standort</th>
                      <th>Anstellungsart</th>
                      <th>Bewerbungen</th>
                      <th>Status</th>
                      <th>Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for job in stellenangebote %}
                    <tr>
                      <td>
                        <strong>{{ job.titel }}</strong>
                        <br><small class="text-muted">{{ job.position_display }}</small>
                      </td>
                      <td>{{ job.standort_plz }} {{ job.standort_stadt }}</td>
                      <td><span class="badge bg-info">{{ job.anstellungsart_display }}</span></td>
                      <td>
                        <span class="badge bg-primary">{{ job.bewerbungen|length }}</span>
                      </td>
                      <td>
                        {% if job.ist_aktiv %}
                        <span class="badge bg-success">Aktiv</span>
                        {% else %}
                        <span class="badge bg-secondary">Inaktiv</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="/stellenangebot/{{ job.slug }}" class="btn btn-outline-primary" target="_blank" title="Vorschau">
                            <i class="fas fa-eye"></i>
                          </a>
                          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editStellenangebotModal{{ job.id }}" title="Bearbeiten">
                            <i class="fas fa-edit"></i>
                          </button>
                          <form action="{{ url_for('dashboard_stellenangebot_toggle', job_id=job.id) }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-{{ 'warning' if job.ist_aktiv else 'success' }}" title="{{ 'Deaktivieren' if job.ist_aktiv else 'Aktivieren' }}">
                              <i class="fas fa-{{ 'pause' if job.ist_aktiv else 'play' }}"></i>
                            </button>
                          </form>
                          <form action="{{ url_for('dashboard_stellenangebot_loeschen', job_id=job.id) }}" method="post" class="d-inline" onsubmit="return confirm('Stellenangebot wirklich löschen?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger" title="Löschen">
                              <i class="fas fa-trash"></i>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="text-center py-5">
                <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Noch keine Stellenangebote vorhanden</h5>
                <p class="text-muted mb-4">Erstellen Sie Ihr erstes Stellenangebot, um qualifizierte Bewerber zu erreichen.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#neuesStellenangebotModal">
                  <i class="fas fa-plus me-1"></i> Erstes Stellenangebot erstellen
                </button>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          {% if praxis and praxis.paket and praxis.paket|lower == 'premiumplus' %}
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
              <h5 class="card-title m-0 fw-bold">
                <i class="fas fa-file-alt me-2 text-primary"></i>Bewerbungen ({{ bewerbungen|length if bewerbungen else 0 }})
              </h5>
            </div>
            <div class="card-body">
              {% if bewerbungen and bewerbungen|length > 0 %}
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Bewerber</th>
                      <th>Stellenangebot</th>
                      <th>Eingegangen</th>
                      <th>Status</th>
                      <th>Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for bewerbung in bewerbungen %}
                    <tr>
                      <td>
                        <strong>{{ bewerbung.vorname }} {{ bewerbung.nachname }}</strong>
                        <br><small class="text-muted">{{ bewerbung.email }}</small>
                        {% if bewerbung.telefon %}
                        <br><small class="text-muted"><i class="fas fa-phone me-1"></i>{{ bewerbung.telefon }}</small>
                        {% endif %}
                      </td>
                      <td>{{ bewerbung.stellenangebot.titel }}</td>
                      <td>{{ bewerbung.eingegangen_am.strftime('%d.%m.%Y') }}</td>
                      <td>
                        <select class="form-select form-select-sm bewerbung-status-select" data-bewerbung-id="{{ bewerbung.id }}" style="min-width: 130px; font-size: 0.8rem;">
                          <option value="neu" {% if bewerbung.status == 'neu' %}selected{% endif %}>Neu</option>
                          <option value="gesehen" {% if bewerbung.status == 'gesehen' %}selected{% endif %}>Gesehen</option>
                          <option value="kontaktiert" {% if bewerbung.status == 'kontaktiert' %}selected{% endif %}>Kontaktiert</option>
                          <option value="eingestellt" {% if bewerbung.status == 'eingestellt' %}selected{% endif %}>Eingestellt</option>
                          <option value="abgelehnt" {% if bewerbung.status == 'abgelehnt' %}selected{% endif %}>Abgelehnt</option>
                        </select>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          {% if bewerbung.telefon %}
                          <a href="tel:{{ bewerbung.telefon }}" class="btn btn-outline-success" title="Anrufen">
                            <i class="fas fa-phone"></i>
                          </a>
                          {% endif %}
                          <a href="mailto:{{ bewerbung.email }}" class="btn btn-outline-secondary" title="E-Mail senden">
                            <i class="fas fa-envelope"></i>
                          </a>
                          <a href="{{ url_for('dashboard_bewerbung_detail', bewerbung_id=bewerbung.id) }}" class="btn btn-outline-primary" title="Details ansehen">
                            <i class="fas fa-eye"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <script>
              document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.bewerbung-status-select').forEach(function(select) {
                  select.addEventListener('change', function() {
                    var bewerbungId = this.dataset.bewerbungId;
                    var neuerStatus = this.value;
                    var selectEl = this;
                    var formData = new FormData();
                    formData.append('status', neuerStatus);
                    formData.append('csrf_token', '{{ csrf_token() }}');
                    
                    fetch('/dashboard/bewerbung/' + bewerbungId + '/status', {
                      method: 'POST',
                      body: formData,
                      headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                      if (data.success) {
                        selectEl.style.borderColor = '#28a745';
                        setTimeout(function() { selectEl.style.borderColor = ''; }, 1500);
                      }
                    })
                    .catch(function() {
                      selectEl.style.borderColor = '#dc3545';
                      setTimeout(function() { selectEl.style.borderColor = ''; }, 1500);
                    });
                  });
                });
              });
              </script>
              {% else %}
              <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">Noch keine Bewerbungen eingegangen</h6>
                <p class="text-muted small mb-0">Sobald Sie Stellenangebote veröffentlichen und Bewerbungen erhalten, werden diese hier angezeigt.</p>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal: Neues Stellenangebot -->
<div class="modal fade" id="neuesStellenangebotModal" tabindex="-1" aria-labelledby="neuesStellenangebotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="neuesStellenangebotModalLabel">
          <i class="fas fa-briefcase me-2 text-primary"></i>Neues Stellenangebot erstellen
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>
      <form action="{{ url_for('dashboard_stellenangebot_erstellen') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <div class="row g-3">
            <div class="col-12">
              <label for="job_titel" class="form-label">Jobtitel *</label>
              <input type="text" class="form-control" id="job_titel" name="titel" placeholder="z.B. Zahnmedizinische/r Fachangestellte/r" required>
            </div>
            <div class="col-md-6">
              <label for="job_position" class="form-label">Position *</label>
              <select class="form-select" id="job_position" name="position" required>
                <option value="">Bitte wählen...</option>
                <optgroup label="Fachpersonal">
                  <option value="zfa">ZFA (Zahnmed. Fachangestellte)</option>
                  <option value="zmf">ZMF (Fachassistentin)</option>
                  <option value="zmv">ZMV (Verwaltungsassistentin)</option>
                  <option value="zmp">ZMP (Prophylaxeassistentin)</option>
                  <option value="dh">Dentalhygieniker/in</option>
                  <option value="prophylaxe">Prophylaxe-Assistent/in</option>
                </optgroup>
                <optgroup label="Zahnärzte">
                  <option value="zahnarzt">Zahnarzt/Zahnärztin</option>
                </optgroup>
                <optgroup label="Spezialisten">
                  <option value="kfo">Kieferorthopäde/in</option>
                  <option value="oralchirurg">Oralchirurg/in / MKG</option>
                  <option value="implantologe">Implantologe/in</option>
                  <option value="endodontologe">Endodontologe/in</option>
                  <option value="parodontologe">Parodontologe/in</option>
                </optgroup>
                <optgroup label="Labor & Technik">
                  <option value="zahntechniker">Zahntechniker/in</option>
                </optgroup>
                <optgroup label="Management & Verwaltung">
                  <option value="praxismanager">Praxismanager/in</option>
                  <option value="rezeption">Rezeption / Empfang</option>
                  <option value="abrechnung">Abrechnung</option>
                  <option value="verwaltung">Verwaltung</option>
                </optgroup>
                <optgroup label="Ausbildung & Sonstige">
                  <option value="azubi">Auszubildende/r</option>
                  <option value="sonstige">Sonstige</option>
                </optgroup>
              </select>
            </div>
            <div class="col-md-6">
              <label for="job_anstellungsart" class="form-label">Anstellungsart *</label>
              <select class="form-select" id="job_anstellungsart" name="anstellungsart" required>
                <option value="vollzeit">Vollzeit</option>
                <option value="teilzeit">Teilzeit</option>
                <option value="ausbildung">Ausbildung</option>
                <option value="minijob">Minijob</option>
                <option value="praktikum">Praktikum</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="job_plz" class="form-label">PLZ</label>
              <input type="text" class="form-control" id="job_plz" name="standort_plz" value="{{ praxis.plz if praxis else '' }}">
            </div>
            <div class="col-md-8">
              <label for="job_stadt" class="form-label">Stadt</label>
              <input type="text" class="form-control" id="job_stadt" name="standort_stadt" value="{{ praxis.stadt if praxis else '' }}">
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="job_ueber_uns" class="form-label mb-0">Über die Praxis</label>
                <button type="button" class="btn btn-outline-primary btn-sm job-ai-btn" data-field="ueber_uns" data-target="job_ueber_uns">
                  <i class="fas fa-magic me-1"></i> KI generieren
                </button>
              </div>
              <textarea class="form-control" id="job_ueber_uns" name="ueber_uns" rows="3" placeholder="Stellen Sie Ihre Praxis kurz vor..."></textarea>
              <small class="text-muted">Wird automatisch aus Ihrer Landingpage-Beschreibung übernommen und optimiert.</small>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="job_aufgaben" class="form-label mb-0">Aufgaben</label>
                <button type="button" class="btn btn-outline-primary btn-sm job-ai-btn" data-field="aufgaben" data-target="job_aufgaben">
                  <i class="fas fa-magic me-1"></i> KI generieren
                </button>
              </div>
              <textarea class="form-control" id="job_aufgaben" name="aufgaben" rows="4" placeholder="Beschreiben Sie die Aufgaben (eine pro Zeile)..."></textarea>
              <small class="text-muted">Jede Zeile wird als separater Aufgabenpunkt dargestellt.</small>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="job_anforderungen" class="form-label mb-0">Anforderungen</label>
                <button type="button" class="btn btn-outline-primary btn-sm job-ai-btn" data-field="anforderungen" data-target="job_anforderungen">
                  <i class="fas fa-magic me-1"></i> KI generieren
                </button>
              </div>
              <textarea class="form-control" id="job_anforderungen" name="anforderungen" rows="4" placeholder="Welche Qualifikationen erwarten Sie? (eine pro Zeile)..."></textarea>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="job_wir_bieten" class="form-label mb-0">Wir bieten</label>
                <button type="button" class="btn btn-outline-primary btn-sm job-ai-btn" data-field="wir_bieten" data-target="job_wir_bieten">
                  <i class="fas fa-magic me-1"></i> KI generieren
                </button>
              </div>
              <textarea class="form-control" id="job_wir_bieten" name="wir_bieten" rows="4" placeholder="Was bieten Sie dem Bewerber? (eine pro Zeile)..."></textarea>
            </div>
            <div class="col-md-4">
              <label for="job_erfahrung" class="form-label">Erfahrung (Jahre)</label>
              <input type="number" class="form-control" id="job_erfahrung" name="erfahrung_jahre" min="0" value="0">
            </div>
            <div class="col-md-8">
              <label for="job_arbeitsbeginn" class="form-label">Arbeitsbeginn</label>
              <input type="text" class="form-control" id="job_arbeitsbeginn" name="arbeitsbeginn" placeholder="z.B. Ab sofort, 01.03.2025">
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="job_tags" class="form-label mb-0">Tags (kommasepariert)</label>
                <button type="button" class="btn btn-outline-primary btn-sm job-ai-btn" data-field="tags" data-target="job_tags">
                  <i class="fas fa-magic me-1"></i> KI generieren
                </button>
              </div>
              <input type="text" class="form-control" id="job_tags" name="tags" placeholder="z.B. Prophylaxe, Digitale Praxis, Flexible Arbeitszeiten">
              <small class="text-muted">Tags helfen Bewerbern, passende Stellen zu finden.</small>
            </div>
            
            <div class="col-12">
              <button type="button" class="btn btn-primary btn-sm" id="job-ai-generate-all">
                <i class="fas fa-magic me-1"></i> Alle Felder mit KI ausfüllen
              </button>
              <small class="text-muted ms-2">Füllt alle leeren Textfelder automatisch mit KI-generierten Vorschlägen.</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Stellenangebot erstellen
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Stellenangebot KI-Generierung -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function getJobFormData() {
    return {
      position: document.getElementById('job_position') ? document.getElementById('job_position').value : '',
      anstellungsart: document.getElementById('job_anstellungsart') ? document.getElementById('job_anstellungsart').value : 'vollzeit',
      existing_fields: {
        'Über uns': document.getElementById('job_ueber_uns') ? document.getElementById('job_ueber_uns').value : '',
        'Aufgaben': document.getElementById('job_aufgaben') ? document.getElementById('job_aufgaben').value : '',
        'Anforderungen': document.getElementById('job_anforderungen') ? document.getElementById('job_anforderungen').value : '',
        'Wir bieten': document.getElementById('job_wir_bieten') ? document.getElementById('job_wir_bieten').value : '',
        'Tags': document.getElementById('job_tags') ? document.getElementById('job_tags').value : ''
      }
    };
  }

  async function generateJobField(fieldType, targetId, btn) {
    var formData = getJobFormData();
    if (!formData.position) {
      alert('Bitte wählen Sie zuerst eine Position aus.');
      return;
    }
    
    var targetEl = document.getElementById(targetId);
    if (!targetEl) return;
    
    var originalBtnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generiere...';
    
    try {
      var response = await fetch('/api/ai/generate-job-text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          field: fieldType,
          position: formData.position,
          anstellungsart: formData.anstellungsart,
          existing_fields: formData.existing_fields
        })
      });
      
      var data = await response.json();
      
      if (data.error) {
        alert('Fehler: ' + data.error);
      } else {
        targetEl.value = data.text;
        targetEl.style.backgroundColor = '#e8f5e9';
        setTimeout(function() { targetEl.style.backgroundColor = ''; }, 2000);
      }
    } catch (error) {
      alert('Verbindungsfehler. Bitte versuchen Sie es erneut.');
    }
    
    btn.disabled = false;
    btn.innerHTML = originalBtnHtml;
  }

  document.querySelectorAll('.job-ai-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var fieldType = this.getAttribute('data-field');
      var targetId = this.getAttribute('data-target');
      generateJobField(fieldType, targetId, this);
    });
  });

  var generateAllBtn = document.getElementById('job-ai-generate-all');
  if (generateAllBtn) {
    generateAllBtn.addEventListener('click', async function() {
      var formData = getJobFormData();
      if (!formData.position) {
        alert('Bitte wählen Sie zuerst eine Position aus.');
        return;
      }
      
      var originalHtml = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generiere alle Felder...';
      
      var fields = [
        { field: 'ueber_uns', target: 'job_ueber_uns' },
        { field: 'aufgaben', target: 'job_aufgaben' },
        { field: 'anforderungen', target: 'job_anforderungen' },
        { field: 'wir_bieten', target: 'job_wir_bieten' },
        { field: 'tags', target: 'job_tags' }
      ];
      
      for (var i = 0; i < fields.length; i++) {
        var f = fields[i];
        var targetEl = document.getElementById(f.target);
        if (targetEl && !targetEl.value.trim()) {
          try {
            var currentFormData = getJobFormData();
            var response = await fetch('/api/ai/generate-job-text', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                field: f.field,
                position: currentFormData.position,
                anstellungsart: currentFormData.anstellungsart,
                existing_fields: currentFormData.existing_fields
              })
            });
            var data = await response.json();
            if (!data.error) {
              targetEl.value = data.text;
              targetEl.style.backgroundColor = '#e8f5e9';
              setTimeout((function(el) { return function() { el.style.backgroundColor = ''; }; })(targetEl), 2000);
            }
          } catch (error) {
            console.error('Fehler bei ' + f.field + ':', error);
          }
        }
      }
      
      this.disabled = false;
      this.innerHTML = originalHtml;
    });
  }
});
</script>

<!-- Dashboard Initializations -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle für monatlich/jährlich auf Plan & Abrechnung
  var zahlweiseToggle = document.getElementById('zahlweiseSwitchDashboard');
  if (zahlweiseToggle) {
    zahlweiseToggle.addEventListener('change', function() {
      var isJaehrlich = this.checked;
      var neueZahlweise = isJaehrlich ? 'jaehrlich' : 'monatlich';
      
      // Versteckte Formularfelder aktualisieren
      document.querySelectorAll('.hidden-zahlweise').forEach(function(el) {
        el.value = neueZahlweise;
      });
      
      // Preisanzeigen umschalten
      document.querySelectorAll('.monatlich-preis').forEach(function(el) {
        el.classList.toggle('d-none', isJaehrlich);
      });
      document.querySelectorAll('.jaehrlich-preis').forEach(function(el) {
        el.classList.toggle('d-none', !isJaehrlich);
      });
    });
  }
  
  // Öffnungszeiten Geschlossen-Toggle
  document.querySelectorAll('.oeffnungszeit-toggle').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      var tag = this.dataset.tag;
      var vonInput = document.querySelector('input[name="oz_' + tag + '_von"]');
      var bisInput = document.querySelector('input[name="oz_' + tag + '_bis"]');
      if (vonInput) vonInput.disabled = this.checked;
      if (bisInput) bisInput.disabled = this.checked;
    });
  });
  
  // Leistungsschwerpunkte Max 5 Limit
  var schwerpunktCheckboxes = document.querySelectorAll('.leistungsschwerpunkt-checkbox');
  var schwerpunkteCountEl = document.getElementById('schwerpunkte-count');
  var maxSchwerpunkte = 5;
  
  function updateSchwerpunkteCount() {
    var checkedCount = document.querySelectorAll('.leistungsschwerpunkt-checkbox:checked').length;
    if (schwerpunkteCountEl) {
      schwerpunkteCountEl.textContent = checkedCount;
    }
    schwerpunktCheckboxes.forEach(function(cb) {
      if (!cb.checked) {
        cb.disabled = checkedCount >= maxSchwerpunkte;
      }
    });
  }
  
  schwerpunktCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', updateSchwerpunkteCount);
  });
  updateSchwerpunkteCount();
  
});
</script>

<style>
/* Dashboard Styles */
.stat-icon-circle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
}

.bg-light-primary {
  background-color: rgba(64, 191, 216, 0.15);
}

.bg-light-success {
  background-color: rgba(40, 167, 69, 0.15);
}

.bg-light-info {
  background-color: rgba(23, 162, 184, 0.15);
}

.bg-light-warning {
  background-color: rgba(255, 193, 7, 0.15);
}

.current-appointment {
  border-left: 4px solid #28a745;
  background-color: rgba(40, 167, 69, 0.05);
}

/* Navigation Styling */
.list-group-item-action {
  padding: 0.75rem 1rem;
  border-radius: 0.25rem;
  margin-bottom: 0.25rem;
  border: none;
  transition: all 0.2s ease;
}

.list-group-item-action:hover,
.list-group-item-action:focus {
  background-color: #f5f5f5;
  color: #40bfd8;
}

.list-group-item-action.active {
  background-color: #40bfd8;
  color: white;
}

/* Calendar Customizations */
.fc-event {
  border-radius: 4px;
  padding: 2px 4px;
  font-size: 0.85rem;
}

.fc-theme-standard td, 
.fc-theme-standard th, 
.fc-theme-standard .fc-scrollgrid {
  border-color: #eee;
}

.fc .fc-timegrid-slot {
  height: 2.5em;
}

.fc .fc-button-primary {
  background-color: #40bfd8;
  border-color: #40bfd8;
}

.fc .fc-button-primary:hover {
  background-color: #2a8294;
  border-color: #2a8294;
}

.fc .fc-button-primary:not(:disabled).fc-button-active, 
.fc .fc-button-primary:not(:disabled):active {
  background-color: #2a8294;
  border-color: #2a8294;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .stat-icon-circle {
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
  }
}
</style>

<script>
async function generateAIText(textType, targetFieldId) {
  const targetField = document.getElementById(targetFieldId);
  const originalContent = targetField.value;
  const btn = event.target.closest('button');
  const originalBtnHtml = btn.innerHTML;
  
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  try {
    const response = await fetch('/api/ai/generate-text', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: textType,
        info: originalContent || ''
      })
    });
    
    const data = await response.json();
    
    if (data.error) {
      alert('Fehler bei der Textgenerierung: ' + data.error);
    } else {
      targetField.value = data.text;
      targetField.style.backgroundColor = '#e8f5e9';
      setTimeout(() => {
        targetField.style.backgroundColor = '';
      }, 2000);
    }
  } catch (error) {
    alert('Verbindungsfehler. Bitte versuchen Sie es erneut.');
  }
  
  btn.disabled = false;
  btn.innerHTML = originalBtnHtml;
}
</script>
{% endblock %}
